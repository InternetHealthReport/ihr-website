import * as AggregatedAlarmsDataModel from '../models/AggregatedAlarmsDataModel';
import { ALARMS_INFO } from '../metadata/AggregatedAlarmsMetadata';
import { ALARMS, IHR_ALARMS_MOCKED } from './resources/data';

const GRIP_ALARMS_MOCKED = [
  {
    'debug': {},
    'duration': null,
    'event_type': 'submoas',
    'finished_ts': null,
    'id': 'submoas-1697845800-174=272907',
    'insert_ts': 1697847037,
    'last_modified_ts': 1697847037,
    'pfx_events': [
      {
        'finished_ts': null,
        'inferences': [
          {
            'confidence': 50,
            'explanation': 'no other inferences found, event is traceroute worthy',
            'inference_id': 'default-tr-worthy',
            'labels': [
              'traceroute'
            ],
            'suspicion_level': 80
          }
        ],
        'sub_pfx': '38.255.24.0/22',
        'super_pfx': '38.0.0.0/8',
      }
    ],
    'summary': {
      'ases': [
        '272907',
        '174'
      ],
      'attackers': [
        '272907'
      ],
      'inference_result': {
        'inferences': [
          {
            'confidence': 50,
            'explanation': 'no other inferences found, event is traceroute worthy',
            'inference_id': 'default-tr-worthy',
            'labels': [
              'traceroute'
            ],
            'suspicion_level': 80
          }
        ],
        'primary_inference': {
          'confidence': 50,
          'explanation': 'no other inferences found, event is traceroute worthy',
          'inference_id': 'default-tr-worthy',
          'labels': [
            'traceroute'
          ],
          'suspicion_level': 80
        }
      },
      'newcomers': [
        '272907'
      ],
      'prefixes': [
        '38.255.24.0/22',
        '38.0.0.0/8'
      ],
      'tr_worthy': true,
      'victims': [
        '174'
      ]
    },
    'tr_metrics': {
      'max_event_ases': 3,
      'max_pfx_events': 2,
      'max_vps_per_event_as': 10,
      'selected_event_as_cnt': 0,
      'selected_pfx_event_cnt': 0,
      'selected_unique_vp_cnt': 0,
      'selected_vp_cnt': 0,
      'total_event_as_cnt': 0,
      'tr_request_cnt': 0,
      'tr_request_failure_cnt': 0,
      'tr_skip_reason': '',
      'tr_skipped': false,
      'tr_worthy': false,
      'tr_worthy_pfx_event_cnt': 0,
      'tr_worthy_tags': [
        [
          'prefix-small-edit-distance',
          'not-previously-announced-by-any-newcomer'
        ]
      ]
    },
    'view_ts': 1697845800
  },
  {
    'debug': {},
    'duration': 63900,
    'event_type': 'submoas',
    'finished_ts': 1697907900,
    'id': 'submoas-1697844000-19957=2386',
    'insert_ts': 1697846167,
    'last_modified_ts': 1697910645,
    'pfx_events': [
      {
        'finished_ts': 1697907900,
        'inferences': [
          {
            'confidence': 50,
            'explanation': 'no other inferences found, event is traceroute worthy',
            'inference_id': 'default-tr-worthy',
            'labels': [
              'traceroute'
            ],
            'suspicion_level': 80
          }
        ],
        'sub_pfx': '170.190.42.0/24',
        'super_pfx': '170.190.40.0/22'
      },
      {
        'finished_ts': 1697907900,
        'inferences': [
          {
            'confidence': 50,
            'explanation': 'no other inferences found, event is traceroute worthy',
            'inference_id': 'default-tr-worthy',
            'labels': [
              'traceroute'
            ],
            'suspicion_level': 80
          }
        ],
        'sub_pfx': '170.190.40.0/24',
        'super_pfx': '170.190.40.0/22'
      },
      {
        'finished_ts': 1697907900,
        'inferences': [
          {
            'confidence': 50,
            'explanation': 'no other inferences found, event is traceroute worthy',
            'inference_id': 'default-tr-worthy',
            'labels': [
              'traceroute'
            ],
            'suspicion_level': 80
          }
        ],
        'sub_pfx': '170.190.43.0/24',
        'super_pfx': '170.190.40.0/22',
      },
      {
        'finished_ts': 1697907900,
        'inferences': [
          {
            'confidence': 50,
            'explanation': 'no other inferences found, event is traceroute worthy',
            'inference_id': 'default-tr-worthy',
            'labels': [
              'traceroute'
            ],
            'suspicion_level': 80
          }
        ],
        'sub_pfx': '170.190.41.0/24',
        'super_pfx': '170.190.40.0/22',
      }
    ],
    'summary': {
      'ases': [
        '2386',
        '19957'
      ],
      'attackers': [
        '2386'
      ],
      'inference_result': {
        'inferences': [
          {
            'confidence': 50,
            'explanation': 'no other inferences found, event is traceroute worthy',
            'inference_id': 'default-tr-worthy',
            'labels': [
              'traceroute'
            ],
            'suspicion_level': 80
          }
        ],
        'primary_inference': {
          'confidence': 50,
          'explanation': 'no other inferences found, event is traceroute worthy',
          'inference_id': 'default-tr-worthy',
          'labels': [
            'traceroute'
          ],
          'suspicion_level': 80
        }
      },
      'newcomers': [
        '2386'
      ],
      'prefixes': [
        '170.190.40.0/24',
        '170.190.41.0/24',
        '170.190.40.0/22',
        '170.190.43.0/24',
        '170.190.42.0/24'
      ],
      'tr_worthy': true,
      'victims': [
        '19957'
      ]
    },
    'tr_metrics': {
      'max_event_ases': 3,
      'max_pfx_events': 2,
      'max_vps_per_event_as': 10,
      'selected_event_as_cnt': 0,
      'selected_pfx_event_cnt': 0,
      'selected_unique_vp_cnt': 0,
      'selected_vp_cnt': 0,
      'total_event_as_cnt': 0,
      'tr_request_cnt': 0,
      'tr_request_failure_cnt': 0,
      'tr_skip_reason': '',
      'tr_skipped': false,
      'tr_worthy': false,
      'tr_worthy_pfx_event_cnt': 0,
      'tr_worthy_tags': [
        [
          'not-previously-announced-by-any-newcomer'
        ]
      ]
    },
    'view_ts': 1697844000
  }
]

const IODA_ALARMS_MOCKED = [
  {
    'datasource': 'bgp',
    'entity': {
      'code': '50369',
      'name': 'AS50369 (SAFEGRID)',
      'type': 'asn',
      'attrs': {
        'fqid': 'asn.50369',
        'name': 'SAFEGRID',
        'org': 'Safegrid Network SRL',
        'ip_count': '4608'
      }
    },
    'time': 1697760000,
    'level': 'critical',
    'condition': '< 0.99',
    'value': 19,
    'historyValue': 21,
    'method': 'median'
  },
  {
    'datasource': 'bgp',
    'entity': {
      'code': '1848',
      'name': 'AS1848 (AS1848)',
      'type': 'asn',
      'attrs': {
        'fqid': 'asn.1848',
        'name': 'AS1848',
        'org': 'National Aeronautics and Space Administration',
        'ip_count': '6144'
      }
    },
    'time': 1697760300,
    'level': 'critical',
    'condition': '< 0.99',
    'value': 1,
    'historyValue': 24,
    'method': 'median'
  },
  {
    'datasource': 'bgp',
    'entity': {
      'code': '199366',
      'name': 'AS199366 (TTNETDC)',
      'type': 'asn',
      'attrs': {
        'fqid': 'asn.199366',
        'name': 'TTNETDC',
        'org': 'Yesilbir Bilisim Teknolojileri Bilgisayar Yayincilik Sanayi ve Ticaret Ltd. Sti.',
        'ip_count': '5376'
      }
    },
    'time': 1697762100,
    'level': 'normal',
    'condition': 'normal',
    'value': 20,
    'historyValue': 20,
    'method': 'median'
  }
]

const AS_NAMES_COUNTRY_MAPPINGS_MOCKED = {
  174: { asn_name: 'COGENT-174', country_iso_code2: 'US' },
  272907: { asn_name: 'CDM.NET, C.A.', country_iso_code2: 'VE' },
  50369: { asn_name: 'SAFEGRID Safegrid Network SRL', country_iso_code2: 'RO' },
  1848: { asn_name: 'AS1848', country_iso_code2: 'US' },
  199366: { asn_name: 'TTNETDC Yesilbir Bilisim Teknolojileri Bilgisayar Yayincilik Sanayi ve Ticaret Ltd. Sti.', country_iso_code2: 'TR' },
  197150: { asn_name: 'MCRBN-AS Federal State Unitary Enterprise of the Order of the Red Banner of Labour "Russian Broad-casting and Notification Network"', country_iso_code2: 'RU' },
  12418: { asn_name: 'QUANTUM Quantum CJSC', country_iso_code2: 'RU' },
  135647: { asn_name: 'AFL-AS-AP Airports Fiji Limited', country_iso_code2: 'FJ' },
  45355: { asn_name: 'DIGICELPACIFIC-1-AP Digicel Fiji Limited', country_iso_code2: 'FJ' },
  8866: { asn_name: 'VIVACOM-AS Vivacom Bulgaria EAD', country_iso_code2: 'BG' },
  42473: { asn_name: 'AS-ANEXIA ANEXIA Internetdienstleistungs GmbH', country_iso_code2: 'AT' },
  397143: { asn_name: 'NEPTUNE-NETWORKS-LEGACY', country_iso_code2: 'US' },
  6461: { asn_name: 'ZAYO-6461', country_iso_code2: 'US' },
  58224: { asn_name: 'TCI Iran Telecommunication Company PJS', country_iso_code2: 'IR' },
  2386: { asn_name: 'INS-AS', country_iso_code2: 'US' },
  19957: { asn_name: 'TENNESSEE-NET', country_iso_code2: 'US' }
}
jest.mock('../../plugins/GripApi', () => ({
  getGripAlarms: jest.fn().mockResolvedValue(GRIP_ALARMS_MOCKED),
}));

jest.mock('../../plugins/IodaApi', () => ({
  getIodaAlarms: jest.fn().mockResolvedValue(IODA_ALARMS_MOCKED),
}));

jest.mock('../../plugins/AsNames', () => ({
  getASNamesCountryMappings: jest.fn().mockResolvedValue(AS_NAMES_COUNTRY_MAPPINGS_MOCKED),
}));

describe('etlAggregatedAlarmsDataModel', () => {
  afterEach(() => {
    jest.clearAllMocks();
  });
  it('should correctly ETL AggregatedAlarmsDataModel for IHR, Grip, and IODA when all data sources are selected', async () => {
    const dataSourcesSelected = { 'ihr': true, 'grip': true, 'ioda': true }
    const alarmTypesSelected = {
      'hegemony': true,
      'network_delay': true,
      'network_disconnection': true,
      'moas': true,
      'submoas': false,
      'defcon': false,
      'edges': false,
      'ping_slash24': false,
      'bgp': true,
      'ucsd_nt': false,
      'merit_nt': false
    }
    const groupByKeys = {
      'hegemony': 'origin_asn',
      'network_delay': 'startpoint',
      'network_disconnection': 'stream',
      'moas': 'asn_attacker',
      'submoas': 'asn_attacker',
      'defcon': 'asn_attacker',
      'edges': 'asn_attacker',
      'ping_slash24': 'entity',
      'bgp': 'entity',
      'ucsd_nt': 'entity',
      'merit_nt': 'entity'
    }
    const externalAlarms = { grip: null, ioda: null }
    const iodaIPAddressFamilies = {
      'ping_slash24': [
        '4'
      ],
      'bgp': [
        '4',
        '6'
      ],
      'ucsd_nt': [
        '4'
      ],
      'merit_nt': [
        '4'
      ]
    }
    const startUnixTime = 1697760000
    const endUnixTime = 1697846399

    const result = await AggregatedAlarmsDataModel.etl(dataSourcesSelected, ALARMS_INFO, alarmTypesSelected, groupByKeys, IHR_ALARMS_MOCKED, externalAlarms, iodaIPAddressFamilies, startUnixTime, endUnixTime)

    const expectedResult = [
      {
        asn: 1848,
        asn_name: 'AS1848',
        asn_country: 'United States',
        asn_country_iso_code2: 'US',
        asn_country_iso_code3: 'USA',
        bgp_entity: [1848],
        bgp_entity_type: ['asn'],
        bgp_entity_name: ['AS1848'],
        bgp_entity_country: ['United States'],
        bgp_entity_country_iso_code2: ['US'],
        bgp_entity_country_iso_code3: ['USA'],
        bgp_entity_af: ['4, 6'],
        bgp_entity_ip_count: [6144],
        bgp_entity_alarm_type: ['bgp'],
        bgp_condition: ['< 0.99'],
        bgp_value: [1],
        bgp_historical_value: [24],
        bgp_severity: ['high'],
        bgp_timebin: [1697760300],
        bgp_count: [1],
        bgp_key: 'entity',
        hegemony_origin_asn: [],
        hegemony_origin_asn_name: [],
        hegemony_origin_asn_country: [],
        hegemony_origin_asn_country_iso_code2: [],
        hegemony_origin_asn_country_iso_code3: [],
        hegemony_origin_asn_af: [],
        hegemony_asn: [],
        hegemony_asn_name: [],
        hegemony_asn_country: [],
        hegemony_asn_country_iso_code2: [],
        hegemony_asn_country_iso_code3: [],
        hegemony_asn_af: [],
        hegemony_timebin: [],
        hegemony_count: [],
        hegemony_severity: [],
        hegemony_deviation: [],
        network_delay_startpoint: [],
        network_delay_startpoint_type: [],
        network_delay_startpoint_name: [],
        network_delay_startpoint_country: [],
        network_delay_startpoint_country_iso_code2: [],
        network_delay_startpoint_country_iso_code3: [],
        network_delay_startpoint_af: [],
        network_delay_endpoint: [],
        network_delay_endpoint_type: [],
        network_delay_endpoint_name: [],
        network_delay_endpoint_country: [],
        network_delay_endpoint_country_iso_code2: [],
        network_delay_endpoint_country_iso_code3: [],
        network_delay_endpoint_af: [],
        network_delay_count: [],
        network_delay_timebin: [],
        network_delay_severity: [],
        network_delay_deviation: [],
        network_disconnection_stream: [],
        network_disconnection_stream_type: [],
        network_disconnection_stream_name: [],
        network_disconnection_stream_country: [],
        network_disconnection_stream_country_iso_code2: [],
        network_disconnection_stream_country_iso_code3: [],
        network_disconnection_stream_af: [],
        network_disconnection_stream_disconnected_prefix: [],
        network_disconnection_stream_prob_id: [],
        network_disconnection_stream_total_probes: [],
        network_disconnection_start_timebin: [],
        network_disconnection_end_timebin: [],
        network_disconnection_timebin: [],
        network_disconnection_stream_id: [],
        network_disconnection_severity: [],
        network_disconnection_deviation: [],
        network_disconnection_duration: [],
        network_disconnection_count: [],
        hegemony_key: 'origin_asn',
        network_delay_key: 'startpoint',
        network_disconnection_key: 'stream',
        asn_name_truncated: 'AS1848 (AS1848)'
      },
      {
        asn: 8866,
        asn_name: 'VIVACOM-AS Vivacom Bulgaria EAD',
        asn_country: 'Bulgaria',
        asn_country_iso_code2: 'BG',
        asn_country_iso_code3: 'BGR',
        hegemony_origin_asn: [],
        hegemony_origin_asn_name: [],
        hegemony_origin_asn_country: [],
        hegemony_origin_asn_country_iso_code2: [],
        hegemony_origin_asn_country_iso_code3: [],
        hegemony_origin_asn_af: [],
        hegemony_asn: [],
        hegemony_asn_name: [],
        hegemony_asn_country: [],
        hegemony_asn_country_iso_code2: [],
        hegemony_asn_country_iso_code3: [],
        hegemony_asn_af: [],
        hegemony_timebin: [],
        hegemony_count: [],
        hegemony_severity: [],
        hegemony_deviation: [],
        network_delay_startpoint: [8866],
        network_delay_startpoint_type: ['AS'],
        network_delay_startpoint_name: ['VIVACOM-AS Vivacom Bulgaria EAD'],
        network_delay_startpoint_country: ['Bulgaria'],
        network_delay_startpoint_country_iso_code2: ['BG'],
        network_delay_startpoint_country_iso_code3: ['BGR'],
        network_delay_startpoint_af: [4],
        network_delay_endpoint: [42473],
        network_delay_endpoint_type: ['AS'],
        network_delay_endpoint_name: ['AS-ANEXIA ANEXIA Internetdienstleistungs GmbH'],
        network_delay_endpoint_country: ['Austria'],
        network_delay_endpoint_country_iso_code2: ['AT'],
        network_delay_endpoint_country_iso_code3: ['AUT'],
        network_delay_endpoint_af: [4],
        network_delay_count: [1],
        network_delay_timebin: [1697843700],
        network_delay_severity: ['low'],
        network_delay_deviation: [11.9389361531127],
        network_disconnection_stream: [],
        network_disconnection_stream_type: [],
        network_disconnection_stream_name: [],
        network_disconnection_stream_country: [],
        network_disconnection_stream_country_iso_code2: [],
        network_disconnection_stream_country_iso_code3: [],
        network_disconnection_stream_af: [],
        network_disconnection_stream_disconnected_prefix: [],
        network_disconnection_stream_prob_id: [],
        network_disconnection_stream_total_probes: [],
        network_disconnection_start_timebin: [],
        network_disconnection_end_timebin: [],
        network_disconnection_timebin: [],
        network_disconnection_stream_id: [],
        network_disconnection_severity: [],
        network_disconnection_deviation: [],
        network_disconnection_duration: [],
        network_disconnection_count: [],
        hegemony_key: 'origin_asn',
        network_delay_key: 'startpoint',
        network_disconnection_key: 'stream',
        bgp_entity: [],
        bgp_entity_type: [],
        bgp_entity_name: [],
        bgp_entity_country: [],
        bgp_entity_country_iso_code2: [],
        bgp_entity_country_iso_code3: [],
        bgp_entity_af: [],
        bgp_entity_ip_count: [],
        bgp_entity_alarm_type: [],
        bgp_condition: [],
        bgp_value: [],
        bgp_historical_value: [],
        bgp_severity: [],
        bgp_timebin: [],
        bgp_count: [],
        bgp_key: 'entity',
        asn_name_truncated: 'VIVACOM-AS (AS8866)'
      },
      {
        asn: 50369,
        asn_name: 'SAFEGRID Safegrid Network SRL',
        asn_country: 'Romania',
        asn_country_iso_code2: 'RO',
        asn_country_iso_code3: 'ROU',
        bgp_entity: [50369],
        bgp_entity_type: ['asn'],
        bgp_entity_name: ['SAFEGRID Safegrid Network SRL'],
        bgp_entity_country: ['Romania'],
        bgp_entity_country_iso_code2: ['RO'],
        bgp_entity_country_iso_code3: ['ROU'],
        bgp_entity_af: ['4, 6'],
        bgp_entity_ip_count: [4608],
        bgp_entity_alarm_type: ['bgp'],
        bgp_condition: ['< 0.99'],
        bgp_value: [19],
        bgp_historical_value: [21],
        bgp_severity: ['high'],
        bgp_timebin: [1697760000],
        bgp_count: [1],
        bgp_key: 'entity',
        hegemony_origin_asn: [],
        hegemony_origin_asn_name: [],
        hegemony_origin_asn_country: [],
        hegemony_origin_asn_country_iso_code2: [],
        hegemony_origin_asn_country_iso_code3: [],
        hegemony_origin_asn_af: [],
        hegemony_asn: [],
        hegemony_asn_name: [],
        hegemony_asn_country: [],
        hegemony_asn_country_iso_code2: [],
        hegemony_asn_country_iso_code3: [],
        hegemony_asn_af: [],
        hegemony_timebin: [],
        hegemony_count: [],
        hegemony_severity: [],
        hegemony_deviation: [],
        network_delay_startpoint: [],
        network_delay_startpoint_type: [],
        network_delay_startpoint_name: [],
        network_delay_startpoint_country: [],
        network_delay_startpoint_country_iso_code2: [],
        network_delay_startpoint_country_iso_code3: [],
        network_delay_startpoint_af: [],
        network_delay_endpoint: [],
        network_delay_endpoint_type: [],
        network_delay_endpoint_name: [],
        network_delay_endpoint_country: [],
        network_delay_endpoint_country_iso_code2: [],
        network_delay_endpoint_country_iso_code3: [],
        network_delay_endpoint_af: [],
        network_delay_count: [],
        network_delay_timebin: [],
        network_delay_severity: [],
        network_delay_deviation: [],
        network_disconnection_stream: [],
        network_disconnection_stream_type: [],
        network_disconnection_stream_name: [],
        network_disconnection_stream_country: [],
        network_disconnection_stream_country_iso_code2: [],
        network_disconnection_stream_country_iso_code3: [],
        network_disconnection_stream_af: [],
        network_disconnection_stream_disconnected_prefix: [],
        network_disconnection_stream_prob_id: [],
        network_disconnection_stream_total_probes: [],
        network_disconnection_start_timebin: [],
        network_disconnection_end_timebin: [],
        network_disconnection_timebin: [],
        network_disconnection_stream_id: [],
        network_disconnection_severity: [],
        network_disconnection_deviation: [],
        network_disconnection_duration: [],
        network_disconnection_count: [],
        hegemony_key: 'origin_asn',
        network_delay_key: 'startpoint',
        network_disconnection_key: 'stream',
        asn_name_truncated: 'SAFEGRID S (AS50369)'
      },
      {
        asn: 58224,
        asn_name: 'TCI Iran Telecommunication Company PJS',
        asn_country: 'Iran',
        asn_country_iso_code2: 'IR',
        asn_country_iso_code3: 'IRN',
        hegemony_origin_asn: [],
        hegemony_origin_asn_name: [],
        hegemony_origin_asn_country: [],
        hegemony_origin_asn_country_iso_code2: [],
        hegemony_origin_asn_country_iso_code3: [],
        hegemony_origin_asn_af: [],
        hegemony_asn: [],
        hegemony_asn_name: [],
        hegemony_asn_country: [],
        hegemony_asn_country_iso_code2: [],
        hegemony_asn_country_iso_code3: [],
        hegemony_asn_af: [],
        hegemony_timebin: [],
        hegemony_count: [],
        hegemony_severity: [],
        hegemony_deviation: [],
        network_delay_startpoint: [],
        network_delay_startpoint_type: [],
        network_delay_startpoint_name: [],
        network_delay_startpoint_country: [],
        network_delay_startpoint_country_iso_code2: [],
        network_delay_startpoint_country_iso_code3: [],
        network_delay_startpoint_af: [],
        network_delay_endpoint: [],
        network_delay_endpoint_type: [],
        network_delay_endpoint_name: [],
        network_delay_endpoint_country: [],
        network_delay_endpoint_country_iso_code2: [],
        network_delay_endpoint_country_iso_code3: [],
        network_delay_endpoint_af: [],
        network_delay_count: [],
        network_delay_timebin: [],
        network_delay_severity: [],
        network_delay_deviation: [],
        network_disconnection_stream: [58224],
        network_disconnection_stream_type: ['asn'],
        network_disconnection_stream_name: ['TCI Iran Telecommunication Company PJS'],
        network_disconnection_stream_country: ['Iran'],
        network_disconnection_stream_country_iso_code2: ['IR'],
        network_disconnection_stream_country_iso_code3: ['IRN'],
        network_disconnection_stream_af: ['4, 4, 4, 4, 4, 4, 4, 4, 4, 4'],
        network_disconnection_stream_disconnected_prefix: [
          '151.245.8.0/22, 151.245.8.0/22, 151.245.8.0/22, 151.245.8.0/22, 151.245.8.0/22, 151.245.8.0/22, 151.245.8.0/22, 151.245.8.0/22, 151.245.8.0/22, 151.245.8.0/22'
        ],
        network_disconnection_stream_prob_id: [
          '27080, 26337, 26313, 24749, 26351, 26328, 24801, 24890, 24806, 25072'
        ],
        network_disconnection_stream_total_probes: [32],
        network_disconnection_start_timebin: [1697828820],
        network_disconnection_end_timebin: [1697828820],
        network_disconnection_timebin: [1697828820],
        network_disconnection_stream_id: [131964651],
        network_disconnection_severity: ['low'],
        network_disconnection_deviation: [12],
        network_disconnection_duration: [null],
        network_disconnection_count: [1],
        hegemony_key: 'origin_asn',
        network_delay_key: 'startpoint',
        network_disconnection_key: 'stream',
        bgp_entity: [],
        bgp_entity_type: [],
        bgp_entity_name: [],
        bgp_entity_country: [],
        bgp_entity_country_iso_code2: [],
        bgp_entity_country_iso_code3: [],
        bgp_entity_af: [],
        bgp_entity_ip_count: [],
        bgp_entity_alarm_type: [],
        bgp_condition: [],
        bgp_value: [],
        bgp_historical_value: [],
        bgp_severity: [],
        bgp_timebin: [],
        bgp_count: [],
        bgp_key: 'entity',
        asn_name_truncated: 'TCI Iran T (AS58224)'
      },
      {
        asn: 135647,
        asn_name: 'AFL-AS-AP Airports Fiji Limited',
        asn_country: 'Fiji',
        asn_country_iso_code2: 'FJ',
        asn_country_iso_code3: 'FJI',
        hegemony_origin_asn: [135647],
        hegemony_origin_asn_name: ['AFL-AS-AP Airports Fiji Limited'],
        hegemony_origin_asn_country: ['Fiji'],
        hegemony_origin_asn_country_iso_code2: ['FJ'],
        hegemony_origin_asn_country_iso_code3: ['FJI'],
        hegemony_origin_asn_af: [4],
        hegemony_asn: [45355],
        hegemony_asn_name: ['DIGICELPACIFIC-1-AP Digicel Fiji Limited'],
        hegemony_asn_country: ['Fiji'],
        hegemony_asn_country_iso_code2: ['FJ'],
        hegemony_asn_country_iso_code3: ['FJI'],
        hegemony_asn_af: [4],
        hegemony_timebin: [1697843700],
        hegemony_count: [1],
        hegemony_severity: ['low'],
        hegemony_deviation: [22.9060399467486],
        network_delay_startpoint: [],
        network_delay_startpoint_type: [],
        network_delay_startpoint_name: [],
        network_delay_startpoint_country: [],
        network_delay_startpoint_country_iso_code2: [],
        network_delay_startpoint_country_iso_code3: [],
        network_delay_startpoint_af: [],
        network_delay_endpoint: [],
        network_delay_endpoint_type: [],
        network_delay_endpoint_name: [],
        network_delay_endpoint_country: [],
        network_delay_endpoint_country_iso_code2: [],
        network_delay_endpoint_country_iso_code3: [],
        network_delay_endpoint_af: [],
        network_delay_count: [],
        network_delay_timebin: [],
        network_delay_severity: [],
        network_delay_deviation: [],
        network_disconnection_stream: [],
        network_disconnection_stream_type: [],
        network_disconnection_stream_name: [],
        network_disconnection_stream_country: [],
        network_disconnection_stream_country_iso_code2: [],
        network_disconnection_stream_country_iso_code3: [],
        network_disconnection_stream_af: [],
        network_disconnection_stream_disconnected_prefix: [],
        network_disconnection_stream_prob_id: [],
        network_disconnection_stream_total_probes: [],
        network_disconnection_start_timebin: [],
        network_disconnection_end_timebin: [],
        network_disconnection_timebin: [],
        network_disconnection_stream_id: [],
        network_disconnection_severity: [],
        network_disconnection_deviation: [],
        network_disconnection_duration: [],
        network_disconnection_count: [],
        hegemony_key: 'origin_asn',
        network_delay_key: 'startpoint',
        network_disconnection_key: 'stream',
        bgp_entity: [],
        bgp_entity_type: [],
        bgp_entity_name: [],
        bgp_entity_country: [],
        bgp_entity_country_iso_code2: [],
        bgp_entity_country_iso_code3: [],
        bgp_entity_af: [],
        bgp_entity_ip_count: [],
        bgp_entity_alarm_type: [],
        bgp_condition: [],
        bgp_value: [],
        bgp_historical_value: [],
        bgp_severity: [],
        bgp_timebin: [],
        bgp_count: [],
        bgp_key: 'entity',
        asn_name_truncated: 'AFL-AS-AP (AS135647)'
      },
      {
        asn: 197150,
        asn_name: 'MCRBN-AS Federal State Unitary Enterprise of the Order of the Red Banner of Labour "Russian Broad-casting and Notification Network"',
        asn_country: 'Russia',
        asn_country_iso_code2: 'RU',
        asn_country_iso_code3: 'RUS',
        hegemony_origin_asn: [197150],
        hegemony_origin_asn_name: [
          'MCRBN-AS Federal State Unitary Enterprise of the Order of the Red Banner of Labour "Russian Broad-casting and Notification Network"'
        ],
        hegemony_origin_asn_country: ['Russia'],
        hegemony_origin_asn_country_iso_code2: ['RU'],
        hegemony_origin_asn_country_iso_code3: ['RUS'],
        hegemony_origin_asn_af: [4],
        hegemony_asn: [12418],
        hegemony_asn_name: ['QUANTUM Quantum CJSC'],
        hegemony_asn_country: ['Russia'],
        hegemony_asn_country_iso_code2: ['RU'],
        hegemony_asn_country_iso_code3: ['RUS'],
        hegemony_asn_af: [4],
        hegemony_timebin: [1697845500],
        hegemony_count: [1],
        hegemony_severity: ['medium'],
        hegemony_deviation: [35.2348037171613],
        network_delay_startpoint: [],
        network_delay_startpoint_type: [],
        network_delay_startpoint_name: [],
        network_delay_startpoint_country: [],
        network_delay_startpoint_country_iso_code2: [],
        network_delay_startpoint_country_iso_code3: [],
        network_delay_startpoint_af: [],
        network_delay_endpoint: [],
        network_delay_endpoint_type: [],
        network_delay_endpoint_name: [],
        network_delay_endpoint_country: [],
        network_delay_endpoint_country_iso_code2: [],
        network_delay_endpoint_country_iso_code3: [],
        network_delay_endpoint_af: [],
        network_delay_count: [],
        network_delay_timebin: [],
        network_delay_severity: [],
        network_delay_deviation: [],
        network_disconnection_stream: [],
        network_disconnection_stream_type: [],
        network_disconnection_stream_name: [],
        network_disconnection_stream_country: [],
        network_disconnection_stream_country_iso_code2: [],
        network_disconnection_stream_country_iso_code3: [],
        network_disconnection_stream_af: [],
        network_disconnection_stream_disconnected_prefix: [],
        network_disconnection_stream_prob_id: [],
        network_disconnection_stream_total_probes: [],
        network_disconnection_start_timebin: [],
        network_disconnection_end_timebin: [],
        network_disconnection_timebin: [],
        network_disconnection_stream_id: [],
        network_disconnection_severity: [],
        network_disconnection_deviation: [],
        network_disconnection_duration: [],
        network_disconnection_count: [],
        hegemony_key: 'origin_asn',
        network_delay_key: 'startpoint',
        network_disconnection_key: 'stream',
        bgp_entity: [],
        bgp_entity_type: [],
        bgp_entity_name: [],
        bgp_entity_country: [],
        bgp_entity_country_iso_code2: [],
        bgp_entity_country_iso_code3: [],
        bgp_entity_af: [],
        bgp_entity_ip_count: [],
        bgp_entity_alarm_type: [],
        bgp_condition: [],
        bgp_value: [],
        bgp_historical_value: [],
        bgp_severity: [],
        bgp_timebin: [],
        bgp_count: [],
        bgp_key: 'entity',
        asn_name_truncated: 'MCRBN-AS F (AS197150)'
      },
      {
        asn: 199366,
        asn_name: 'TTNETDC Yesilbir Bilisim Teknolojileri Bilgisayar Yayincilik Sanayi ve Ticaret Ltd. Sti.',
        asn_country: 'Turkey',
        asn_country_iso_code2: 'TR',
        asn_country_iso_code3: 'TUR',
        bgp_entity: [199366],
        bgp_entity_type: ['asn'],
        bgp_entity_name: [
          'TTNETDC Yesilbir Bilisim Teknolojileri Bilgisayar Yayincilik Sanayi ve Ticaret Ltd. Sti.'
        ],
        bgp_entity_country: ['Turkey'],
        bgp_entity_country_iso_code2: ['TR'],
        bgp_entity_country_iso_code3: ['TUR'],
        bgp_entity_af: ['4, 6'],
        bgp_entity_ip_count: [5376],
        bgp_entity_alarm_type: ['bgp'],
        bgp_condition: ['normal'],
        bgp_value: [20],
        bgp_historical_value: [20],
        bgp_severity: ['medium'],
        bgp_timebin: [1697762100],
        bgp_count: [1],
        bgp_key: 'entity',
        hegemony_origin_asn: [],
        hegemony_origin_asn_name: [],
        hegemony_origin_asn_country: [],
        hegemony_origin_asn_country_iso_code2: [],
        hegemony_origin_asn_country_iso_code3: [],
        hegemony_origin_asn_af: [],
        hegemony_asn: [],
        hegemony_asn_name: [],
        hegemony_asn_country: [],
        hegemony_asn_country_iso_code2: [],
        hegemony_asn_country_iso_code3: [],
        hegemony_asn_af: [],
        hegemony_timebin: [],
        hegemony_count: [],
        hegemony_severity: [],
        hegemony_deviation: [],
        network_delay_startpoint: [],
        network_delay_startpoint_type: [],
        network_delay_startpoint_name: [],
        network_delay_startpoint_country: [],
        network_delay_startpoint_country_iso_code2: [],
        network_delay_startpoint_country_iso_code3: [],
        network_delay_startpoint_af: [],
        network_delay_endpoint: [],
        network_delay_endpoint_type: [],
        network_delay_endpoint_name: [],
        network_delay_endpoint_country: [],
        network_delay_endpoint_country_iso_code2: [],
        network_delay_endpoint_country_iso_code3: [],
        network_delay_endpoint_af: [],
        network_delay_count: [],
        network_delay_timebin: [],
        network_delay_severity: [],
        network_delay_deviation: [],
        network_disconnection_stream: [],
        network_disconnection_stream_type: [],
        network_disconnection_stream_name: [],
        network_disconnection_stream_country: [],
        network_disconnection_stream_country_iso_code2: [],
        network_disconnection_stream_country_iso_code3: [],
        network_disconnection_stream_af: [],
        network_disconnection_stream_disconnected_prefix: [],
        network_disconnection_stream_prob_id: [],
        network_disconnection_stream_total_probes: [],
        network_disconnection_start_timebin: [],
        network_disconnection_end_timebin: [],
        network_disconnection_timebin: [],
        network_disconnection_stream_id: [],
        network_disconnection_severity: [],
        network_disconnection_deviation: [],
        network_disconnection_duration: [],
        network_disconnection_count: [],
        hegemony_key: 'origin_asn',
        network_delay_key: 'startpoint',
        network_disconnection_key: 'stream',
        asn_name_truncated: 'TTNETDC Ye (AS199366)'
      },
      {
        asn: 397143,
        asn_name: 'NEPTUNE-NETWORKS-LEGACY',
        asn_country: 'United States',
        asn_country_iso_code2: 'US',
        asn_country_iso_code3: 'USA',
        hegemony_origin_asn: [],
        hegemony_origin_asn_name: [],
        hegemony_origin_asn_country: [],
        hegemony_origin_asn_country_iso_code2: [],
        hegemony_origin_asn_country_iso_code3: [],
        hegemony_origin_asn_af: [],
        hegemony_asn: [],
        hegemony_asn_name: [],
        hegemony_asn_country: [],
        hegemony_asn_country_iso_code2: [],
        hegemony_asn_country_iso_code3: [],
        hegemony_asn_af: [],
        hegemony_timebin: [],
        hegemony_count: [],
        hegemony_severity: [],
        hegemony_deviation: [],
        network_delay_startpoint: [397143],
        network_delay_startpoint_type: ['AS'],
        network_delay_startpoint_name: ['NEPTUNE-NETWORKS-LEGACY'],
        network_delay_startpoint_country: ['United States'],
        network_delay_startpoint_country_iso_code2: ['US'],
        network_delay_startpoint_country_iso_code3: ['USA'],
        network_delay_startpoint_af: [4],
        network_delay_endpoint: [6461],
        network_delay_endpoint_type: ['AS'],
        network_delay_endpoint_name: ['ZAYO-6461'],
        network_delay_endpoint_country: ['United States'],
        network_delay_endpoint_country_iso_code2: ['US'],
        network_delay_endpoint_country_iso_code3: ['USA'],
        network_delay_endpoint_af: [4],
        network_delay_count: [1],
        network_delay_timebin: [1697843700],
        network_delay_severity: ['low'],
        network_delay_deviation: [14.6861362079549],
        network_disconnection_stream: [],
        network_disconnection_stream_type: [],
        network_disconnection_stream_name: [],
        network_disconnection_stream_country: [],
        network_disconnection_stream_country_iso_code2: [],
        network_disconnection_stream_country_iso_code3: [],
        network_disconnection_stream_af: [],
        network_disconnection_stream_disconnected_prefix: [],
        network_disconnection_stream_prob_id: [],
        network_disconnection_stream_total_probes: [],
        network_disconnection_start_timebin: [],
        network_disconnection_end_timebin: [],
        network_disconnection_timebin: [],
        network_disconnection_stream_id: [],
        network_disconnection_severity: [],
        network_disconnection_deviation: [],
        network_disconnection_duration: [],
        network_disconnection_count: [],
        hegemony_key: 'origin_asn',
        network_delay_key: 'startpoint',
        network_disconnection_key: 'stream',
        bgp_entity: [],
        bgp_entity_type: [],
        bgp_entity_name: [],
        bgp_entity_country: [],
        bgp_entity_country_iso_code2: [],
        bgp_entity_country_iso_code3: [],
        bgp_entity_af: [],
        bgp_entity_ip_count: [],
        bgp_entity_alarm_type: [],
        bgp_condition: [],
        bgp_value: [],
        bgp_historical_value: [],
        bgp_severity: [],
        bgp_timebin: [],
        bgp_count: [],
        bgp_key: 'entity',
        asn_name_truncated: 'NEPTUNE-NE (AS397143)'
      }
    ]
    expect(result).toEqual(expectedResult)
  });

  it('should correctly ETL AggregatedAlarmsDataModel for IHR only', async () => {
    const dataSourcesSelected = { 'ihr': true, 'grip': false, 'ioda': false }
    const alarmTypesSelected = {
      'hegemony': true,
      'network_delay': true,
      'network_disconnection': true,
      'moas': false,
      'submoas': false,
      'defcon': false,
      'edges': false,
      'ping_slash24': false,
      'bgp': false,
      'ucsd_nt': false,
      'merit_nt': false
    }
    const groupByKeys = {
      'hegemony': 'origin_asn',
      'network_delay': 'startpoint',
      'network_disconnection': 'stream',
      'moas': 'asn_attacker',
      'submoas': 'asn_attacker',
      'defcon': 'asn_attacker',
      'edges': 'asn_attacker',
      'ping_slash24': 'entity',
      'bgp': 'entity',
      'ucsd_nt': 'entity',
      'merit_nt': 'entity'
    }
    const externalAlarms = { grip: null, ioda: null }
    const iodaIPAddressFamilies = {
      'ping_slash24': [
        '4'
      ],
      'bgp': [
        '4',
        '6'
      ],
      'ucsd_nt': [
        '4'
      ],
      'merit_nt': [
        '4'
      ]
    }
    const startUnixTime = 1697760000
    const endUnixTime = 1697846399

    const result = await AggregatedAlarmsDataModel.etl(dataSourcesSelected, ALARMS_INFO, alarmTypesSelected, groupByKeys, IHR_ALARMS_MOCKED, externalAlarms, iodaIPAddressFamilies, startUnixTime, endUnixTime)

    const expectedResult = [
      {
        asn: 8866,
        asn_name: 'VIVACOM-AS Vivacom Bulgaria EAD',
        asn_country: 'Bulgaria',
        asn_country_iso_code2: 'BG',
        asn_country_iso_code3: 'BGR',
        hegemony_origin_asn: [],
        hegemony_origin_asn_name: [],
        hegemony_origin_asn_country: [],
        hegemony_origin_asn_country_iso_code2: [],
        hegemony_origin_asn_country_iso_code3: [],
        hegemony_origin_asn_af: [],
        hegemony_asn: [],
        hegemony_asn_name: [],
        hegemony_asn_country: [],
        hegemony_asn_country_iso_code2: [],
        hegemony_asn_country_iso_code3: [],
        hegemony_asn_af: [],
        hegemony_timebin: [],
        hegemony_count: [],
        hegemony_severity: [],
        hegemony_deviation: [],
        network_delay_startpoint: [8866],
        network_delay_startpoint_type: ['AS'],
        network_delay_startpoint_name: ['VIVACOM-AS Vivacom Bulgaria EAD'],
        network_delay_startpoint_country: ['Bulgaria'],
        network_delay_startpoint_country_iso_code2: ['BG'],
        network_delay_startpoint_country_iso_code3: ['BGR'],
        network_delay_startpoint_af: [4],
        network_delay_endpoint: [42473],
        network_delay_endpoint_type: ['AS'],
        network_delay_endpoint_name: ['AS-ANEXIA ANEXIA Internetdienstleistungs GmbH'],
        network_delay_endpoint_country: ['Austria'],
        network_delay_endpoint_country_iso_code2: ['AT'],
        network_delay_endpoint_country_iso_code3: ['AUT'],
        network_delay_endpoint_af: [4],
        network_delay_count: [1],
        network_delay_timebin: [1697843700],
        network_delay_severity: ['low'],
        network_delay_deviation: [11.9389361531127],
        network_disconnection_stream: [],
        network_disconnection_stream_type: [],
        network_disconnection_stream_name: [],
        network_disconnection_stream_country: [],
        network_disconnection_stream_country_iso_code2: [],
        network_disconnection_stream_country_iso_code3: [],
        network_disconnection_stream_af: [],
        network_disconnection_stream_disconnected_prefix: [],
        network_disconnection_stream_prob_id: [],
        network_disconnection_stream_total_probes: [],
        network_disconnection_start_timebin: [],
        network_disconnection_end_timebin: [],
        network_disconnection_timebin: [],
        network_disconnection_stream_id: [],
        network_disconnection_severity: [],
        network_disconnection_deviation: [],
        network_disconnection_duration: [],
        network_disconnection_count: [],
        hegemony_key: 'origin_asn',
        network_delay_key: 'startpoint',
        network_disconnection_key: 'stream',
        asn_name_truncated: 'VIVACOM-AS (AS8866)'
      },
      {
        asn: 58224,
        asn_name: 'TCI Iran Telecommunication Company PJS',
        asn_country: 'Iran',
        asn_country_iso_code2: 'IR',
        asn_country_iso_code3: 'IRN',
        hegemony_origin_asn: [],
        hegemony_origin_asn_name: [],
        hegemony_origin_asn_country: [],
        hegemony_origin_asn_country_iso_code2: [],
        hegemony_origin_asn_country_iso_code3: [],
        hegemony_origin_asn_af: [],
        hegemony_asn: [],
        hegemony_asn_name: [],
        hegemony_asn_country: [],
        hegemony_asn_country_iso_code2: [],
        hegemony_asn_country_iso_code3: [],
        hegemony_asn_af: [],
        hegemony_timebin: [],
        hegemony_count: [],
        hegemony_severity: [],
        hegemony_deviation: [],
        network_delay_startpoint: [],
        network_delay_startpoint_type: [],
        network_delay_startpoint_name: [],
        network_delay_startpoint_country: [],
        network_delay_startpoint_country_iso_code2: [],
        network_delay_startpoint_country_iso_code3: [],
        network_delay_startpoint_af: [],
        network_delay_endpoint: [],
        network_delay_endpoint_type: [],
        network_delay_endpoint_name: [],
        network_delay_endpoint_country: [],
        network_delay_endpoint_country_iso_code2: [],
        network_delay_endpoint_country_iso_code3: [],
        network_delay_endpoint_af: [],
        network_delay_count: [],
        network_delay_timebin: [],
        network_delay_severity: [],
        network_delay_deviation: [],
        network_disconnection_stream: [58224],
        network_disconnection_stream_type: ['asn'],
        network_disconnection_stream_name: ['TCI Iran Telecommunication Company PJS'],
        network_disconnection_stream_country: ['Iran'],
        network_disconnection_stream_country_iso_code2: ['IR'],
        network_disconnection_stream_country_iso_code3: ['IRN'],
        network_disconnection_stream_af: ['4, 4, 4, 4, 4, 4, 4, 4, 4, 4'],
        network_disconnection_stream_disconnected_prefix: [
          '151.245.8.0/22, 151.245.8.0/22, 151.245.8.0/22, 151.245.8.0/22, 151.245.8.0/22, 151.245.8.0/22, 151.245.8.0/22, 151.245.8.0/22, 151.245.8.0/22, 151.245.8.0/22'
        ],
        network_disconnection_stream_prob_id: [
          '27080, 26337, 26313, 24749, 26351, 26328, 24801, 24890, 24806, 25072'
        ],
        network_disconnection_stream_total_probes: [32],
        network_disconnection_start_timebin: [1697828820],
        network_disconnection_end_timebin: [1697828820],
        network_disconnection_timebin: [1697828820],
        network_disconnection_stream_id: [131964651],
        network_disconnection_severity: ['low'],
        network_disconnection_deviation: [12],
        network_disconnection_duration: [null],
        network_disconnection_count: [1],
        hegemony_key: 'origin_asn',
        network_delay_key: 'startpoint',
        network_disconnection_key: 'stream',
        asn_name_truncated: 'TCI Iran T (AS58224)'
      },
      {
        asn: 135647,
        asn_name: 'AFL-AS-AP Airports Fiji Limited',
        asn_country: 'Fiji',
        asn_country_iso_code2: 'FJ',
        asn_country_iso_code3: 'FJI',
        hegemony_origin_asn: [135647],
        hegemony_origin_asn_name: ['AFL-AS-AP Airports Fiji Limited'],
        hegemony_origin_asn_country: ['Fiji'],
        hegemony_origin_asn_country_iso_code2: ['FJ'],
        hegemony_origin_asn_country_iso_code3: ['FJI'],
        hegemony_origin_asn_af: [4],
        hegemony_asn: [45355],
        hegemony_asn_name: ['DIGICELPACIFIC-1-AP Digicel Fiji Limited'],
        hegemony_asn_country: ['Fiji'],
        hegemony_asn_country_iso_code2: ['FJ'],
        hegemony_asn_country_iso_code3: ['FJI'],
        hegemony_asn_af: [4],
        hegemony_timebin: [1697843700],
        hegemony_count: [1],
        hegemony_severity: ['low'],
        hegemony_deviation: [22.9060399467486],
        network_delay_startpoint: [],
        network_delay_startpoint_type: [],
        network_delay_startpoint_name: [],
        network_delay_startpoint_country: [],
        network_delay_startpoint_country_iso_code2: [],
        network_delay_startpoint_country_iso_code3: [],
        network_delay_startpoint_af: [],
        network_delay_endpoint: [],
        network_delay_endpoint_type: [],
        network_delay_endpoint_name: [],
        network_delay_endpoint_country: [],
        network_delay_endpoint_country_iso_code2: [],
        network_delay_endpoint_country_iso_code3: [],
        network_delay_endpoint_af: [],
        network_delay_count: [],
        network_delay_timebin: [],
        network_delay_severity: [],
        network_delay_deviation: [],
        network_disconnection_stream: [],
        network_disconnection_stream_type: [],
        network_disconnection_stream_name: [],
        network_disconnection_stream_country: [],
        network_disconnection_stream_country_iso_code2: [],
        network_disconnection_stream_country_iso_code3: [],
        network_disconnection_stream_af: [],
        network_disconnection_stream_disconnected_prefix: [],
        network_disconnection_stream_prob_id: [],
        network_disconnection_stream_total_probes: [],
        network_disconnection_start_timebin: [],
        network_disconnection_end_timebin: [],
        network_disconnection_timebin: [],
        network_disconnection_stream_id: [],
        network_disconnection_severity: [],
        network_disconnection_deviation: [],
        network_disconnection_duration: [],
        network_disconnection_count: [],
        hegemony_key: 'origin_asn',
        network_delay_key: 'startpoint',
        network_disconnection_key: 'stream',
        asn_name_truncated: 'AFL-AS-AP (AS135647)'
      },
      {
        asn: 197150,
        asn_name: 'MCRBN-AS Federal State Unitary Enterprise of the Order of the Red Banner of Labour "Russian Broad-casting and Notification Network"',
        asn_country: 'Russia',
        asn_country_iso_code2: 'RU',
        asn_country_iso_code3: 'RUS',
        hegemony_origin_asn: [197150],
        hegemony_origin_asn_name: [
          'MCRBN-AS Federal State Unitary Enterprise of the Order of the Red Banner of Labour "Russian Broad-casting and Notification Network"'
        ],
        hegemony_origin_asn_country: ['Russia'],
        hegemony_origin_asn_country_iso_code2: ['RU'],
        hegemony_origin_asn_country_iso_code3: ['RUS'],
        hegemony_origin_asn_af: [4],
        hegemony_asn: [12418],
        hegemony_asn_name: ['QUANTUM Quantum CJSC'],
        hegemony_asn_country: ['Russia'],
        hegemony_asn_country_iso_code2: ['RU'],
        hegemony_asn_country_iso_code3: ['RUS'],
        hegemony_asn_af: [4],
        hegemony_timebin: [1697845500],
        hegemony_count: [1],
        hegemony_severity: ['medium'],
        hegemony_deviation: [35.2348037171613],
        network_delay_startpoint: [],
        network_delay_startpoint_type: [],
        network_delay_startpoint_name: [],
        network_delay_startpoint_country: [],
        network_delay_startpoint_country_iso_code2: [],
        network_delay_startpoint_country_iso_code3: [],
        network_delay_startpoint_af: [],
        network_delay_endpoint: [],
        network_delay_endpoint_type: [],
        network_delay_endpoint_name: [],
        network_delay_endpoint_country: [],
        network_delay_endpoint_country_iso_code2: [],
        network_delay_endpoint_country_iso_code3: [],
        network_delay_endpoint_af: [],
        network_delay_count: [],
        network_delay_timebin: [],
        network_delay_severity: [],
        network_delay_deviation: [],
        network_disconnection_stream: [],
        network_disconnection_stream_type: [],
        network_disconnection_stream_name: [],
        network_disconnection_stream_country: [],
        network_disconnection_stream_country_iso_code2: [],
        network_disconnection_stream_country_iso_code3: [],
        network_disconnection_stream_af: [],
        network_disconnection_stream_disconnected_prefix: [],
        network_disconnection_stream_prob_id: [],
        network_disconnection_stream_total_probes: [],
        network_disconnection_start_timebin: [],
        network_disconnection_end_timebin: [],
        network_disconnection_timebin: [],
        network_disconnection_stream_id: [],
        network_disconnection_severity: [],
        network_disconnection_deviation: [],
        network_disconnection_duration: [],
        network_disconnection_count: [],
        hegemony_key: 'origin_asn',
        network_delay_key: 'startpoint',
        network_disconnection_key: 'stream',
        asn_name_truncated: 'MCRBN-AS F (AS197150)'
      },
      {
        asn: 397143,
        asn_name: 'NEPTUNE-NETWORKS-LEGACY',
        asn_country: 'United States',
        asn_country_iso_code2: 'US',
        asn_country_iso_code3: 'USA',
        hegemony_origin_asn: [],
        hegemony_origin_asn_name: [],
        hegemony_origin_asn_country: [],
        hegemony_origin_asn_country_iso_code2: [],
        hegemony_origin_asn_country_iso_code3: [],
        hegemony_origin_asn_af: [],
        hegemony_asn: [],
        hegemony_asn_name: [],
        hegemony_asn_country: [],
        hegemony_asn_country_iso_code2: [],
        hegemony_asn_country_iso_code3: [],
        hegemony_asn_af: [],
        hegemony_timebin: [],
        hegemony_count: [],
        hegemony_severity: [],
        hegemony_deviation: [],
        network_delay_startpoint: [397143],
        network_delay_startpoint_type: ['AS'],
        network_delay_startpoint_name: ['NEPTUNE-NETWORKS-LEGACY'],
        network_delay_startpoint_country: ['United States'],
        network_delay_startpoint_country_iso_code2: ['US'],
        network_delay_startpoint_country_iso_code3: ['USA'],
        network_delay_startpoint_af: [4],
        network_delay_endpoint: [6461],
        network_delay_endpoint_type: ['AS'],
        network_delay_endpoint_name: ['ZAYO-6461'],
        network_delay_endpoint_country: ['United States'],
        network_delay_endpoint_country_iso_code2: ['US'],
        network_delay_endpoint_country_iso_code3: ['USA'],
        network_delay_endpoint_af: [4],
        network_delay_count: [1],
        network_delay_timebin: [1697843700],
        network_delay_severity: ['low'],
        network_delay_deviation: [14.6861362079549],
        network_disconnection_stream: [],
        network_disconnection_stream_type: [],
        network_disconnection_stream_name: [],
        network_disconnection_stream_country: [],
        network_disconnection_stream_country_iso_code2: [],
        network_disconnection_stream_country_iso_code3: [],
        network_disconnection_stream_af: [],
        network_disconnection_stream_disconnected_prefix: [],
        network_disconnection_stream_prob_id: [],
        network_disconnection_stream_total_probes: [],
        network_disconnection_start_timebin: [],
        network_disconnection_end_timebin: [],
        network_disconnection_timebin: [],
        network_disconnection_stream_id: [],
        network_disconnection_severity: [],
        network_disconnection_deviation: [],
        network_disconnection_duration: [],
        network_disconnection_count: [],
        hegemony_key: 'origin_asn',
        network_delay_key: 'startpoint',
        network_disconnection_key: 'stream',
        asn_name_truncated: 'NEPTUNE-NE (AS397143)'
      }
    ]
    expect(result).toEqual(expectedResult)
  });

  it('should correctly ETL AggregatedAlarmsDataModel for third party alarms only', async () => {
    const dataSourcesSelected = { 'ihr': false, 'grip': true, 'ioda': true }
    const alarmTypesSelected = {
      'hegemony': false,
      'network_delay': false,
      'network_disconnection': false,
      'moas': true,
      'submoas': true,
      'defcon': true,
      'edges': true,
      'ping_slash24': true,
      'bgp': true,
      'ucsd_nt': true,
      'merit_nt': true
    }
    const groupByKeys = {
      'hegemony': 'origin_asn',
      'network_delay': 'startpoint',
      'network_disconnection': 'stream',
      'moas': 'asn_attacker',
      'submoas': 'asn_attacker',
      'defcon': 'asn_attacker',
      'edges': 'asn_attacker',
      'ping_slash24': 'entity',
      'bgp': 'entity',
      'ucsd_nt': 'entity',
      'merit_nt': 'entity'
    }
    const externalAlarms = { grip: null, ioda: null }
    const iodaIPAddressFamilies = {
      'ping_slash24': [
        '4'
      ],
      'bgp': [
        '4',
        '6'
      ],
      'ucsd_nt': [
        '4'
      ],
      'merit_nt': [
        '4'
      ]
    }
    const startUnixTime = 1697760000
    const endUnixTime = 1697846399

    const result = await AggregatedAlarmsDataModel.etl(dataSourcesSelected, ALARMS_INFO, alarmTypesSelected, groupByKeys, IHR_ALARMS_MOCKED, externalAlarms, iodaIPAddressFamilies, startUnixTime, endUnixTime)

    const expectedResult = [
      {
        asn: 1848,
        asn_name: 'AS1848',
        asn_country: 'United States',
        asn_country_iso_code2: 'US',
        asn_country_iso_code3: 'USA',
        ping_slash24_entity: [],
        ping_slash24_entity_type: [],
        ping_slash24_entity_name: [],
        ping_slash24_entity_country: [],
        ping_slash24_entity_country_iso_code2: [],
        ping_slash24_entity_country_iso_code3: [],
        ping_slash24_entity_af: [],
        ping_slash24_entity_ip_count: [],
        ping_slash24_entity_alarm_type: [],
        ping_slash24_condition: [],
        ping_slash24_value: [],
        ping_slash24_historical_value: [],
        ping_slash24_severity: [],
        ping_slash24_timebin: [],
        ping_slash24_count: [],
        bgp_entity: [1848],
        bgp_entity_type: ['asn'],
        bgp_entity_name: ['AS1848'],
        bgp_entity_country: ['United States'],
        bgp_entity_country_iso_code2: ['US'],
        bgp_entity_country_iso_code3: ['USA'],
        bgp_entity_af: ['4, 6'],
        bgp_entity_ip_count: [6144],
        bgp_entity_alarm_type: ['bgp'],
        bgp_condition: ['< 0.99'],
        bgp_value: [1],
        bgp_historical_value: [24],
        bgp_severity: ['high'],
        bgp_timebin: [1697760300],
        bgp_count: [1],
        ucsd_nt_entity: [],
        ucsd_nt_entity_type: [],
        ucsd_nt_entity_name: [],
        ucsd_nt_entity_country: [],
        ucsd_nt_entity_country_iso_code2: [],
        ucsd_nt_entity_country_iso_code3: [],
        ucsd_nt_entity_af: [],
        ucsd_nt_entity_ip_count: [],
        ucsd_nt_entity_alarm_type: [],
        ucsd_nt_condition: [],
        ucsd_nt_value: [],
        ucsd_nt_historical_value: [],
        ucsd_nt_severity: [],
        ucsd_nt_timebin: [],
        ucsd_nt_count: [],
        merit_nt_entity: [],
        merit_nt_entity_type: [],
        merit_nt_entity_name: [],
        merit_nt_entity_country: [],
        merit_nt_entity_country_iso_code2: [],
        merit_nt_entity_country_iso_code3: [],
        merit_nt_entity_af: [],
        merit_nt_entity_ip_count: [],
        merit_nt_entity_alarm_type: [],
        merit_nt_condition: [],
        merit_nt_value: [],
        merit_nt_historical_value: [],
        merit_nt_severity: [],
        merit_nt_timebin: [],
        merit_nt_count: [],
        ping_slash24_key: 'entity',
        bgp_key: 'entity',
        ucsd_nt_key: 'entity',
        merit_nt_key: 'entity',
        moas_asn_attacker: [],
        moas_asn_attacker_name: [],
        moas_asn_attacker_country: [],
        moas_asn_attacker_country_iso_code2: [],
        moas_asn_attacker_country_iso_code3: [],
        moas_asn_attacker_af: [],
        moas_asn_attacker_newcomer: [],
        moas_asn_attacker_attacking_prefix: [],
        moas_asn_attacker_trustworthy: [],
        moas_asn_attacker_trustworthy_tag: [],
        moas_asn_victim: [],
        moas_asn_victim_name: [],
        moas_asn_victim_country: [],
        moas_asn_victim_country_iso_code2: [],
        moas_asn_victim_country_iso_code3: [],
        moas_asn_victim_newcomer: [],
        moas_asn_victim_trustworthy: [],
        moas_asn_victim_trustworthy_tag: [],
        moas_asn_victim_af: [],
        moas_timebin: [],
        moas_count: [],
        moas_severity: [],
        moas_deviation: [],
        moas_duration: [],
        submoas_asn_attacker: [],
        submoas_asn_attacker_name: [],
        submoas_asn_attacker_country: [],
        submoas_asn_attacker_country_iso_code2: [],
        submoas_asn_attacker_country_iso_code3: [],
        submoas_asn_attacker_af: [],
        submoas_asn_attacker_newcomer: [],
        submoas_asn_attacker_attacking_prefix: [],
        submoas_asn_attacker_trustworthy: [],
        submoas_asn_attacker_trustworthy_tag: [],
        submoas_asn_victim: [],
        submoas_asn_victim_name: [],
        submoas_asn_victim_country: [],
        submoas_asn_victim_country_iso_code2: [],
        submoas_asn_victim_country_iso_code3: [],
        submoas_asn_victim_newcomer: [],
        submoas_asn_victim_trustworthy: [],
        submoas_asn_victim_trustworthy_tag: [],
        submoas_asn_victim_af: [],
        submoas_timebin: [],
        submoas_count: [],
        submoas_severity: [],
        submoas_deviation: [],
        submoas_duration: [],
        defcon_asn_attacker: [],
        defcon_asn_attacker_name: [],
        defcon_asn_attacker_country: [],
        defcon_asn_attacker_country_iso_code2: [],
        defcon_asn_attacker_country_iso_code3: [],
        defcon_asn_attacker_af: [],
        defcon_asn_attacker_newcomer: [],
        defcon_asn_attacker_attacking_prefix: [],
        defcon_asn_attacker_trustworthy: [],
        defcon_asn_attacker_trustworthy_tag: [],
        defcon_asn_victim: [],
        defcon_asn_victim_name: [],
        defcon_asn_victim_country: [],
        defcon_asn_victim_country_iso_code2: [],
        defcon_asn_victim_country_iso_code3: [],
        defcon_asn_victim_newcomer: [],
        defcon_asn_victim_trustworthy: [],
        defcon_asn_victim_trustworthy_tag: [],
        defcon_asn_victim_af: [],
        defcon_timebin: [],
        defcon_count: [],
        defcon_severity: [],
        defcon_deviation: [],
        defcon_duration: [],
        edges_asn_attacker: [],
        edges_asn_attacker_name: [],
        edges_asn_attacker_country: [],
        edges_asn_attacker_country_iso_code2: [],
        edges_asn_attacker_country_iso_code3: [],
        edges_asn_attacker_af: [],
        edges_asn_attacker_newcomer: [],
        edges_asn_attacker_attacking_prefix: [],
        edges_asn_attacker_trustworthy: [],
        edges_asn_attacker_trustworthy_tag: [],
        edges_asn_victim: [],
        edges_asn_victim_name: [],
        edges_asn_victim_country: [],
        edges_asn_victim_country_iso_code2: [],
        edges_asn_victim_country_iso_code3: [],
        edges_asn_victim_newcomer: [],
        edges_asn_victim_trustworthy: [],
        edges_asn_victim_trustworthy_tag: [],
        edges_asn_victim_af: [],
        edges_timebin: [],
        edges_count: [],
        edges_severity: [],
        edges_deviation: [],
        edges_duration: [],
        moas_key: 'asn_attacker',
        submoas_key: 'asn_attacker',
        defcon_key: 'asn_attacker',
        edges_key: 'asn_attacker',
        asn_name_truncated: 'AS1848 (AS1848)'
      },
      {
        asn: 2386,
        asn_name: 'INS-AS',
        asn_country: 'United States',
        asn_country_iso_code2: 'US',
        asn_country_iso_code3: 'USA',
        moas_asn_attacker: [],
        moas_asn_attacker_name: [],
        moas_asn_attacker_country: [],
        moas_asn_attacker_country_iso_code2: [],
        moas_asn_attacker_country_iso_code3: [],
        moas_asn_attacker_af: [],
        moas_asn_attacker_newcomer: [],
        moas_asn_attacker_attacking_prefix: [],
        moas_asn_attacker_trustworthy: [],
        moas_asn_attacker_trustworthy_tag: [],
        moas_asn_victim: [],
        moas_asn_victim_name: [],
        moas_asn_victim_country: [],
        moas_asn_victim_country_iso_code2: [],
        moas_asn_victim_country_iso_code3: [],
        moas_asn_victim_newcomer: [],
        moas_asn_victim_trustworthy: [],
        moas_asn_victim_trustworthy_tag: [],
        moas_asn_victim_af: [],
        moas_timebin: [],
        moas_count: [],
        moas_severity: [],
        moas_deviation: [],
        moas_duration: [],
        submoas_asn_attacker: [2386],
        submoas_asn_attacker_name: ['INS-AS'],
        submoas_asn_attacker_country: ['United States'],
        submoas_asn_attacker_country_iso_code2: ['US'],
        submoas_asn_attacker_country_iso_code3: ['USA'],
        submoas_asn_attacker_af: ['4, 4, 4, 4, 4'],
        submoas_asn_attacker_newcomer: [true],
        submoas_asn_attacker_attacking_prefix: [
          '170.190.40.0/24, 170.190.41.0/24, 170.190.40.0/22, 170.190.43.0/24, 170.190.42.0/24'
        ],
        submoas_asn_attacker_trustworthy: [true],
        submoas_asn_attacker_trustworthy_tag: ['not-previously-announced-by-any-newcomer'],
        submoas_asn_victim: [19957],
        submoas_asn_victim_name: ['TENNESSEE-NET'],
        submoas_asn_victim_country: ['United States'],
        submoas_asn_victim_country_iso_code2: ['US'],
        submoas_asn_victim_country_iso_code3: ['USA'],
        submoas_asn_victim_newcomer: [false],
        submoas_asn_victim_trustworthy: [true],
        submoas_asn_victim_trustworthy_tag: ['not-previously-announced-by-any-newcomer'],
        submoas_asn_victim_af: ['4, 4, 4, 4, 4'],
        submoas_timebin: [1697910645],
        submoas_count: [1],
        submoas_severity: ['high'],
        submoas_deviation: [80],
        submoas_duration: [1065],
        defcon_asn_attacker: [],
        defcon_asn_attacker_name: [],
        defcon_asn_attacker_country: [],
        defcon_asn_attacker_country_iso_code2: [],
        defcon_asn_attacker_country_iso_code3: [],
        defcon_asn_attacker_af: [],
        defcon_asn_attacker_newcomer: [],
        defcon_asn_attacker_attacking_prefix: [],
        defcon_asn_attacker_trustworthy: [],
        defcon_asn_attacker_trustworthy_tag: [],
        defcon_asn_victim: [],
        defcon_asn_victim_name: [],
        defcon_asn_victim_country: [],
        defcon_asn_victim_country_iso_code2: [],
        defcon_asn_victim_country_iso_code3: [],
        defcon_asn_victim_newcomer: [],
        defcon_asn_victim_trustworthy: [],
        defcon_asn_victim_trustworthy_tag: [],
        defcon_asn_victim_af: [],
        defcon_timebin: [],
        defcon_count: [],
        defcon_severity: [],
        defcon_deviation: [],
        defcon_duration: [],
        edges_asn_attacker: [],
        edges_asn_attacker_name: [],
        edges_asn_attacker_country: [],
        edges_asn_attacker_country_iso_code2: [],
        edges_asn_attacker_country_iso_code3: [],
        edges_asn_attacker_af: [],
        edges_asn_attacker_newcomer: [],
        edges_asn_attacker_attacking_prefix: [],
        edges_asn_attacker_trustworthy: [],
        edges_asn_attacker_trustworthy_tag: [],
        edges_asn_victim: [],
        edges_asn_victim_name: [],
        edges_asn_victim_country: [],
        edges_asn_victim_country_iso_code2: [],
        edges_asn_victim_country_iso_code3: [],
        edges_asn_victim_newcomer: [],
        edges_asn_victim_trustworthy: [],
        edges_asn_victim_trustworthy_tag: [],
        edges_asn_victim_af: [],
        edges_timebin: [],
        edges_count: [],
        edges_severity: [],
        edges_deviation: [],
        edges_duration: [],
        moas_key: 'asn_attacker',
        submoas_key: 'asn_attacker',
        defcon_key: 'asn_attacker',
        edges_key: 'asn_attacker',
        ping_slash24_entity: [],
        ping_slash24_entity_type: [],
        ping_slash24_entity_name: [],
        ping_slash24_entity_country: [],
        ping_slash24_entity_country_iso_code2: [],
        ping_slash24_entity_country_iso_code3: [],
        ping_slash24_entity_af: [],
        ping_slash24_entity_ip_count: [],
        ping_slash24_entity_alarm_type: [],
        ping_slash24_condition: [],
        ping_slash24_value: [],
        ping_slash24_historical_value: [],
        ping_slash24_severity: [],
        ping_slash24_timebin: [],
        ping_slash24_count: [],
        bgp_entity: [],
        bgp_entity_type: [],
        bgp_entity_name: [],
        bgp_entity_country: [],
        bgp_entity_country_iso_code2: [],
        bgp_entity_country_iso_code3: [],
        bgp_entity_af: [],
        bgp_entity_ip_count: [],
        bgp_entity_alarm_type: [],
        bgp_condition: [],
        bgp_value: [],
        bgp_historical_value: [],
        bgp_severity: [],
        bgp_timebin: [],
        bgp_count: [],
        ucsd_nt_entity: [],
        ucsd_nt_entity_type: [],
        ucsd_nt_entity_name: [],
        ucsd_nt_entity_country: [],
        ucsd_nt_entity_country_iso_code2: [],
        ucsd_nt_entity_country_iso_code3: [],
        ucsd_nt_entity_af: [],
        ucsd_nt_entity_ip_count: [],
        ucsd_nt_entity_alarm_type: [],
        ucsd_nt_condition: [],
        ucsd_nt_value: [],
        ucsd_nt_historical_value: [],
        ucsd_nt_severity: [],
        ucsd_nt_timebin: [],
        ucsd_nt_count: [],
        merit_nt_entity: [],
        merit_nt_entity_type: [],
        merit_nt_entity_name: [],
        merit_nt_entity_country: [],
        merit_nt_entity_country_iso_code2: [],
        merit_nt_entity_country_iso_code3: [],
        merit_nt_entity_af: [],
        merit_nt_entity_ip_count: [],
        merit_nt_entity_alarm_type: [],
        merit_nt_condition: [],
        merit_nt_value: [],
        merit_nt_historical_value: [],
        merit_nt_severity: [],
        merit_nt_timebin: [],
        merit_nt_count: [],
        ping_slash24_key: 'entity',
        bgp_key: 'entity',
        ucsd_nt_key: 'entity',
        merit_nt_key: 'entity',
        asn_name_truncated: 'INS-AS (AS2386)'
      },
      {
        asn: 50369,
        asn_name: 'SAFEGRID Safegrid Network SRL',
        asn_country: 'Romania',
        asn_country_iso_code2: 'RO',
        asn_country_iso_code3: 'ROU',
        ping_slash24_entity: [],
        ping_slash24_entity_type: [],
        ping_slash24_entity_name: [],
        ping_slash24_entity_country: [],
        ping_slash24_entity_country_iso_code2: [],
        ping_slash24_entity_country_iso_code3: [],
        ping_slash24_entity_af: [],
        ping_slash24_entity_ip_count: [],
        ping_slash24_entity_alarm_type: [],
        ping_slash24_condition: [],
        ping_slash24_value: [],
        ping_slash24_historical_value: [],
        ping_slash24_severity: [],
        ping_slash24_timebin: [],
        ping_slash24_count: [],
        bgp_entity: [50369],
        bgp_entity_type: ['asn'],
        bgp_entity_name: ['SAFEGRID Safegrid Network SRL'],
        bgp_entity_country: ['Romania'],
        bgp_entity_country_iso_code2: ['RO'],
        bgp_entity_country_iso_code3: ['ROU'],
        bgp_entity_af: ['4, 6'],
        bgp_entity_ip_count: [4608],
        bgp_entity_alarm_type: ['bgp'],
        bgp_condition: ['< 0.99'],
        bgp_value: [19],
        bgp_historical_value: [21],
        bgp_severity: ['high'],
        bgp_timebin: [1697760000],
        bgp_count: [1],
        ucsd_nt_entity: [],
        ucsd_nt_entity_type: [],
        ucsd_nt_entity_name: [],
        ucsd_nt_entity_country: [],
        ucsd_nt_entity_country_iso_code2: [],
        ucsd_nt_entity_country_iso_code3: [],
        ucsd_nt_entity_af: [],
        ucsd_nt_entity_ip_count: [],
        ucsd_nt_entity_alarm_type: [],
        ucsd_nt_condition: [],
        ucsd_nt_value: [],
        ucsd_nt_historical_value: [],
        ucsd_nt_severity: [],
        ucsd_nt_timebin: [],
        ucsd_nt_count: [],
        merit_nt_entity: [],
        merit_nt_entity_type: [],
        merit_nt_entity_name: [],
        merit_nt_entity_country: [],
        merit_nt_entity_country_iso_code2: [],
        merit_nt_entity_country_iso_code3: [],
        merit_nt_entity_af: [],
        merit_nt_entity_ip_count: [],
        merit_nt_entity_alarm_type: [],
        merit_nt_condition: [],
        merit_nt_value: [],
        merit_nt_historical_value: [],
        merit_nt_severity: [],
        merit_nt_timebin: [],
        merit_nt_count: [],
        ping_slash24_key: 'entity',
        bgp_key: 'entity',
        ucsd_nt_key: 'entity',
        merit_nt_key: 'entity',
        moas_asn_attacker: [],
        moas_asn_attacker_name: [],
        moas_asn_attacker_country: [],
        moas_asn_attacker_country_iso_code2: [],
        moas_asn_attacker_country_iso_code3: [],
        moas_asn_attacker_af: [],
        moas_asn_attacker_newcomer: [],
        moas_asn_attacker_attacking_prefix: [],
        moas_asn_attacker_trustworthy: [],
        moas_asn_attacker_trustworthy_tag: [],
        moas_asn_victim: [],
        moas_asn_victim_name: [],
        moas_asn_victim_country: [],
        moas_asn_victim_country_iso_code2: [],
        moas_asn_victim_country_iso_code3: [],
        moas_asn_victim_newcomer: [],
        moas_asn_victim_trustworthy: [],
        moas_asn_victim_trustworthy_tag: [],
        moas_asn_victim_af: [],
        moas_timebin: [],
        moas_count: [],
        moas_severity: [],
        moas_deviation: [],
        moas_duration: [],
        submoas_asn_attacker: [],
        submoas_asn_attacker_name: [],
        submoas_asn_attacker_country: [],
        submoas_asn_attacker_country_iso_code2: [],
        submoas_asn_attacker_country_iso_code3: [],
        submoas_asn_attacker_af: [],
        submoas_asn_attacker_newcomer: [],
        submoas_asn_attacker_attacking_prefix: [],
        submoas_asn_attacker_trustworthy: [],
        submoas_asn_attacker_trustworthy_tag: [],
        submoas_asn_victim: [],
        submoas_asn_victim_name: [],
        submoas_asn_victim_country: [],
        submoas_asn_victim_country_iso_code2: [],
        submoas_asn_victim_country_iso_code3: [],
        submoas_asn_victim_newcomer: [],
        submoas_asn_victim_trustworthy: [],
        submoas_asn_victim_trustworthy_tag: [],
        submoas_asn_victim_af: [],
        submoas_timebin: [],
        submoas_count: [],
        submoas_severity: [],
        submoas_deviation: [],
        submoas_duration: [],
        defcon_asn_attacker: [],
        defcon_asn_attacker_name: [],
        defcon_asn_attacker_country: [],
        defcon_asn_attacker_country_iso_code2: [],
        defcon_asn_attacker_country_iso_code3: [],
        defcon_asn_attacker_af: [],
        defcon_asn_attacker_newcomer: [],
        defcon_asn_attacker_attacking_prefix: [],
        defcon_asn_attacker_trustworthy: [],
        defcon_asn_attacker_trustworthy_tag: [],
        defcon_asn_victim: [],
        defcon_asn_victim_name: [],
        defcon_asn_victim_country: [],
        defcon_asn_victim_country_iso_code2: [],
        defcon_asn_victim_country_iso_code3: [],
        defcon_asn_victim_newcomer: [],
        defcon_asn_victim_trustworthy: [],
        defcon_asn_victim_trustworthy_tag: [],
        defcon_asn_victim_af: [],
        defcon_timebin: [],
        defcon_count: [],
        defcon_severity: [],
        defcon_deviation: [],
        defcon_duration: [],
        edges_asn_attacker: [],
        edges_asn_attacker_name: [],
        edges_asn_attacker_country: [],
        edges_asn_attacker_country_iso_code2: [],
        edges_asn_attacker_country_iso_code3: [],
        edges_asn_attacker_af: [],
        edges_asn_attacker_newcomer: [],
        edges_asn_attacker_attacking_prefix: [],
        edges_asn_attacker_trustworthy: [],
        edges_asn_attacker_trustworthy_tag: [],
        edges_asn_victim: [],
        edges_asn_victim_name: [],
        edges_asn_victim_country: [],
        edges_asn_victim_country_iso_code2: [],
        edges_asn_victim_country_iso_code3: [],
        edges_asn_victim_newcomer: [],
        edges_asn_victim_trustworthy: [],
        edges_asn_victim_trustworthy_tag: [],
        edges_asn_victim_af: [],
        edges_timebin: [],
        edges_count: [],
        edges_severity: [],
        edges_deviation: [],
        edges_duration: [],
        moas_key: 'asn_attacker',
        submoas_key: 'asn_attacker',
        defcon_key: 'asn_attacker',
        edges_key: 'asn_attacker',
        asn_name_truncated: 'SAFEGRID S (AS50369)'
      },
      {
        asn: 199366,
        asn_name: 'TTNETDC Yesilbir Bilisim Teknolojileri Bilgisayar Yayincilik Sanayi ve Ticaret Ltd. Sti.',
        asn_country: 'Turkey',
        asn_country_iso_code2: 'TR',
        asn_country_iso_code3: 'TUR',
        ping_slash24_entity: [],
        ping_slash24_entity_type: [],
        ping_slash24_entity_name: [],
        ping_slash24_entity_country: [],
        ping_slash24_entity_country_iso_code2: [],
        ping_slash24_entity_country_iso_code3: [],
        ping_slash24_entity_af: [],
        ping_slash24_entity_ip_count: [],
        ping_slash24_entity_alarm_type: [],
        ping_slash24_condition: [],
        ping_slash24_value: [],
        ping_slash24_historical_value: [],
        ping_slash24_severity: [],
        ping_slash24_timebin: [],
        ping_slash24_count: [],
        bgp_entity: [199366],
        bgp_entity_type: ['asn'],
        bgp_entity_name: [
          'TTNETDC Yesilbir Bilisim Teknolojileri Bilgisayar Yayincilik Sanayi ve Ticaret Ltd. Sti.'
        ],
        bgp_entity_country: ['Turkey'],
        bgp_entity_country_iso_code2: ['TR'],
        bgp_entity_country_iso_code3: ['TUR'],
        bgp_entity_af: ['4, 6'],
        bgp_entity_ip_count: [5376],
        bgp_entity_alarm_type: ['bgp'],
        bgp_condition: ['normal'],
        bgp_value: [20],
        bgp_historical_value: [20],
        bgp_severity: ['medium'],
        bgp_timebin: [1697762100],
        bgp_count: [1],
        ucsd_nt_entity: [],
        ucsd_nt_entity_type: [],
        ucsd_nt_entity_name: [],
        ucsd_nt_entity_country: [],
        ucsd_nt_entity_country_iso_code2: [],
        ucsd_nt_entity_country_iso_code3: [],
        ucsd_nt_entity_af: [],
        ucsd_nt_entity_ip_count: [],
        ucsd_nt_entity_alarm_type: [],
        ucsd_nt_condition: [],
        ucsd_nt_value: [],
        ucsd_nt_historical_value: [],
        ucsd_nt_severity: [],
        ucsd_nt_timebin: [],
        ucsd_nt_count: [],
        merit_nt_entity: [],
        merit_nt_entity_type: [],
        merit_nt_entity_name: [],
        merit_nt_entity_country: [],
        merit_nt_entity_country_iso_code2: [],
        merit_nt_entity_country_iso_code3: [],
        merit_nt_entity_af: [],
        merit_nt_entity_ip_count: [],
        merit_nt_entity_alarm_type: [],
        merit_nt_condition: [],
        merit_nt_value: [],
        merit_nt_historical_value: [],
        merit_nt_severity: [],
        merit_nt_timebin: [],
        merit_nt_count: [],
        ping_slash24_key: 'entity',
        bgp_key: 'entity',
        ucsd_nt_key: 'entity',
        merit_nt_key: 'entity',
        moas_asn_attacker: [],
        moas_asn_attacker_name: [],
        moas_asn_attacker_country: [],
        moas_asn_attacker_country_iso_code2: [],
        moas_asn_attacker_country_iso_code3: [],
        moas_asn_attacker_af: [],
        moas_asn_attacker_newcomer: [],
        moas_asn_attacker_attacking_prefix: [],
        moas_asn_attacker_trustworthy: [],
        moas_asn_attacker_trustworthy_tag: [],
        moas_asn_victim: [],
        moas_asn_victim_name: [],
        moas_asn_victim_country: [],
        moas_asn_victim_country_iso_code2: [],
        moas_asn_victim_country_iso_code3: [],
        moas_asn_victim_newcomer: [],
        moas_asn_victim_trustworthy: [],
        moas_asn_victim_trustworthy_tag: [],
        moas_asn_victim_af: [],
        moas_timebin: [],
        moas_count: [],
        moas_severity: [],
        moas_deviation: [],
        moas_duration: [],
        submoas_asn_attacker: [],
        submoas_asn_attacker_name: [],
        submoas_asn_attacker_country: [],
        submoas_asn_attacker_country_iso_code2: [],
        submoas_asn_attacker_country_iso_code3: [],
        submoas_asn_attacker_af: [],
        submoas_asn_attacker_newcomer: [],
        submoas_asn_attacker_attacking_prefix: [],
        submoas_asn_attacker_trustworthy: [],
        submoas_asn_attacker_trustworthy_tag: [],
        submoas_asn_victim: [],
        submoas_asn_victim_name: [],
        submoas_asn_victim_country: [],
        submoas_asn_victim_country_iso_code2: [],
        submoas_asn_victim_country_iso_code3: [],
        submoas_asn_victim_newcomer: [],
        submoas_asn_victim_trustworthy: [],
        submoas_asn_victim_trustworthy_tag: [],
        submoas_asn_victim_af: [],
        submoas_timebin: [],
        submoas_count: [],
        submoas_severity: [],
        submoas_deviation: [],
        submoas_duration: [],
        defcon_asn_attacker: [],
        defcon_asn_attacker_name: [],
        defcon_asn_attacker_country: [],
        defcon_asn_attacker_country_iso_code2: [],
        defcon_asn_attacker_country_iso_code3: [],
        defcon_asn_attacker_af: [],
        defcon_asn_attacker_newcomer: [],
        defcon_asn_attacker_attacking_prefix: [],
        defcon_asn_attacker_trustworthy: [],
        defcon_asn_attacker_trustworthy_tag: [],
        defcon_asn_victim: [],
        defcon_asn_victim_name: [],
        defcon_asn_victim_country: [],
        defcon_asn_victim_country_iso_code2: [],
        defcon_asn_victim_country_iso_code3: [],
        defcon_asn_victim_newcomer: [],
        defcon_asn_victim_trustworthy: [],
        defcon_asn_victim_trustworthy_tag: [],
        defcon_asn_victim_af: [],
        defcon_timebin: [],
        defcon_count: [],
        defcon_severity: [],
        defcon_deviation: [],
        defcon_duration: [],
        edges_asn_attacker: [],
        edges_asn_attacker_name: [],
        edges_asn_attacker_country: [],
        edges_asn_attacker_country_iso_code2: [],
        edges_asn_attacker_country_iso_code3: [],
        edges_asn_attacker_af: [],
        edges_asn_attacker_newcomer: [],
        edges_asn_attacker_attacking_prefix: [],
        edges_asn_attacker_trustworthy: [],
        edges_asn_attacker_trustworthy_tag: [],
        edges_asn_victim: [],
        edges_asn_victim_name: [],
        edges_asn_victim_country: [],
        edges_asn_victim_country_iso_code2: [],
        edges_asn_victim_country_iso_code3: [],
        edges_asn_victim_newcomer: [],
        edges_asn_victim_trustworthy: [],
        edges_asn_victim_trustworthy_tag: [],
        edges_asn_victim_af: [],
        edges_timebin: [],
        edges_count: [],
        edges_severity: [],
        edges_deviation: [],
        edges_duration: [],
        moas_key: 'asn_attacker',
        submoas_key: 'asn_attacker',
        defcon_key: 'asn_attacker',
        edges_key: 'asn_attacker',
        asn_name_truncated: 'TTNETDC Ye (AS199366)'
      },
      {
        asn: 272907,
        asn_name: 'CDM.NET, C.A.',
        asn_country: 'Venezuela',
        asn_country_iso_code2: 'VE',
        asn_country_iso_code3: 'VEN',
        moas_asn_attacker: [],
        moas_asn_attacker_name: [],
        moas_asn_attacker_country: [],
        moas_asn_attacker_country_iso_code2: [],
        moas_asn_attacker_country_iso_code3: [],
        moas_asn_attacker_af: [],
        moas_asn_attacker_newcomer: [],
        moas_asn_attacker_attacking_prefix: [],
        moas_asn_attacker_trustworthy: [],
        moas_asn_attacker_trustworthy_tag: [],
        moas_asn_victim: [],
        moas_asn_victim_name: [],
        moas_asn_victim_country: [],
        moas_asn_victim_country_iso_code2: [],
        moas_asn_victim_country_iso_code3: [],
        moas_asn_victim_newcomer: [],
        moas_asn_victim_trustworthy: [],
        moas_asn_victim_trustworthy_tag: [],
        moas_asn_victim_af: [],
        moas_timebin: [],
        moas_count: [],
        moas_severity: [],
        moas_deviation: [],
        moas_duration: [],
        submoas_asn_attacker: [272907],
        submoas_asn_attacker_name: ['CDM.NET, C.A.'],
        submoas_asn_attacker_country: ['Venezuela'],
        submoas_asn_attacker_country_iso_code2: ['VE'],
        submoas_asn_attacker_country_iso_code3: ['VEN'],
        submoas_asn_attacker_af: ['4, 4'],
        submoas_asn_attacker_newcomer: [true],
        submoas_asn_attacker_attacking_prefix: ['38.255.24.0/22, 38.0.0.0/8'],
        submoas_asn_attacker_trustworthy: [true],
        submoas_asn_attacker_trustworthy_tag: [
          'prefix-small-edit-distance, not-previously-announced-by-any-newcomer'
        ],
        submoas_asn_victim: [174],
        submoas_asn_victim_name: ['COGENT-174'],
        submoas_asn_victim_country: ['United States'],
        submoas_asn_victim_country_iso_code2: ['US'],
        submoas_asn_victim_country_iso_code3: ['USA'],
        submoas_asn_victim_newcomer: [false],
        submoas_asn_victim_trustworthy: [true],
        submoas_asn_victim_trustworthy_tag: [
          'prefix-small-edit-distance, not-previously-announced-by-any-newcomer'
        ],
        submoas_asn_victim_af: ['4, 4'],
        submoas_timebin: [1697847037],
        submoas_count: [1],
        submoas_severity: ['high'],
        submoas_deviation: [80],
        submoas_duration: [null],
        defcon_asn_attacker: [],
        defcon_asn_attacker_name: [],
        defcon_asn_attacker_country: [],
        defcon_asn_attacker_country_iso_code2: [],
        defcon_asn_attacker_country_iso_code3: [],
        defcon_asn_attacker_af: [],
        defcon_asn_attacker_newcomer: [],
        defcon_asn_attacker_attacking_prefix: [],
        defcon_asn_attacker_trustworthy: [],
        defcon_asn_attacker_trustworthy_tag: [],
        defcon_asn_victim: [],
        defcon_asn_victim_name: [],
        defcon_asn_victim_country: [],
        defcon_asn_victim_country_iso_code2: [],
        defcon_asn_victim_country_iso_code3: [],
        defcon_asn_victim_newcomer: [],
        defcon_asn_victim_trustworthy: [],
        defcon_asn_victim_trustworthy_tag: [],
        defcon_asn_victim_af: [],
        defcon_timebin: [],
        defcon_count: [],
        defcon_severity: [],
        defcon_deviation: [],
        defcon_duration: [],
        edges_asn_attacker: [],
        edges_asn_attacker_name: [],
        edges_asn_attacker_country: [],
        edges_asn_attacker_country_iso_code2: [],
        edges_asn_attacker_country_iso_code3: [],
        edges_asn_attacker_af: [],
        edges_asn_attacker_newcomer: [],
        edges_asn_attacker_attacking_prefix: [],
        edges_asn_attacker_trustworthy: [],
        edges_asn_attacker_trustworthy_tag: [],
        edges_asn_victim: [],
        edges_asn_victim_name: [],
        edges_asn_victim_country: [],
        edges_asn_victim_country_iso_code2: [],
        edges_asn_victim_country_iso_code3: [],
        edges_asn_victim_newcomer: [],
        edges_asn_victim_trustworthy: [],
        edges_asn_victim_trustworthy_tag: [],
        edges_asn_victim_af: [],
        edges_timebin: [],
        edges_count: [],
        edges_severity: [],
        edges_deviation: [],
        edges_duration: [],
        moas_key: 'asn_attacker',
        submoas_key: 'asn_attacker',
        defcon_key: 'asn_attacker',
        edges_key: 'asn_attacker',
        ping_slash24_entity: [],
        ping_slash24_entity_type: [],
        ping_slash24_entity_name: [],
        ping_slash24_entity_country: [],
        ping_slash24_entity_country_iso_code2: [],
        ping_slash24_entity_country_iso_code3: [],
        ping_slash24_entity_af: [],
        ping_slash24_entity_ip_count: [],
        ping_slash24_entity_alarm_type: [],
        ping_slash24_condition: [],
        ping_slash24_value: [],
        ping_slash24_historical_value: [],
        ping_slash24_severity: [],
        ping_slash24_timebin: [],
        ping_slash24_count: [],
        bgp_entity: [],
        bgp_entity_type: [],
        bgp_entity_name: [],
        bgp_entity_country: [],
        bgp_entity_country_iso_code2: [],
        bgp_entity_country_iso_code3: [],
        bgp_entity_af: [],
        bgp_entity_ip_count: [],
        bgp_entity_alarm_type: [],
        bgp_condition: [],
        bgp_value: [],
        bgp_historical_value: [],
        bgp_severity: [],
        bgp_timebin: [],
        bgp_count: [],
        ucsd_nt_entity: [],
        ucsd_nt_entity_type: [],
        ucsd_nt_entity_name: [],
        ucsd_nt_entity_country: [],
        ucsd_nt_entity_country_iso_code2: [],
        ucsd_nt_entity_country_iso_code3: [],
        ucsd_nt_entity_af: [],
        ucsd_nt_entity_ip_count: [],
        ucsd_nt_entity_alarm_type: [],
        ucsd_nt_condition: [],
        ucsd_nt_value: [],
        ucsd_nt_historical_value: [],
        ucsd_nt_severity: [],
        ucsd_nt_timebin: [],
        ucsd_nt_count: [],
        merit_nt_entity: [],
        merit_nt_entity_type: [],
        merit_nt_entity_name: [],
        merit_nt_entity_country: [],
        merit_nt_entity_country_iso_code2: [],
        merit_nt_entity_country_iso_code3: [],
        merit_nt_entity_af: [],
        merit_nt_entity_ip_count: [],
        merit_nt_entity_alarm_type: [],
        merit_nt_condition: [],
        merit_nt_value: [],
        merit_nt_historical_value: [],
        merit_nt_severity: [],
        merit_nt_timebin: [],
        merit_nt_count: [],
        ping_slash24_key: 'entity',
        bgp_key: 'entity',
        ucsd_nt_key: 'entity',
        merit_nt_key: 'entity',
        asn_name_truncated: 'CDM.NET, C (AS272907)'
      }
    ]
    expect(result).toEqual(expectedResult)
  });

  it('should handle the case where there is no alarms selected', async () => {
    const dataSourcesSelected = { 'ihr': false, 'grip': false, 'ioda': false }
    const alarmTypesSelected = {
      'hegemony': false,
      'network_delay': false,
      'network_disconnection': false,
      'moas': false,
      'submoas': false,
      'defcon': false,
      'edges': false,
      'ping_slash24': false,
      'bgp': false,
      'ucsd_nt': false,
      'merit_nt': false
    }
    const groupByKeys = {
      'hegemony': 'origin_asn',
      'network_delay': 'startpoint',
      'network_disconnection': 'stream',
      'moas': 'asn_attacker',
      'submoas': 'asn_attacker',
      'defcon': 'asn_attacker',
      'edges': 'asn_attacker',
      'ping_slash24': 'entity',
      'bgp': 'entity',
      'ucsd_nt': 'entity',
      'merit_nt': 'entity'
    }
    const externalAlarms = { grip: null, ioda: null }
    const iodaIPAddressFamilies = {
      'ping_slash24': [
        '4'
      ],
      'bgp': [
        '4',
        '6'
      ],
      'ucsd_nt': [
        '4'
      ],
      'merit_nt': [
        '4'
      ]
    }
    const startUnixTime = 1697760000
    const endUnixTime = 1697846399

    const result = await AggregatedAlarmsDataModel.etl(dataSourcesSelected, ALARMS_INFO, alarmTypesSelected, groupByKeys, IHR_ALARMS_MOCKED, externalAlarms, iodaIPAddressFamilies, startUnixTime, endUnixTime)

    const expectedResult = []

    expect(result).toEqual(expectedResult)
  });

})

describe('filterAlarmsByTime', () => {
  const AGGREGATED_ATTRS_ZIPPED = [
    [
      'hegemony_count',
      'hegemony_timebin',
      'hegemony_severity',
      [
        'hegemony_origin_asn_af',
        'hegemony_asn_af'
      ]
    ],
    [
      'network_delay_count',
      'network_delay_timebin',
      'network_delay_severity',
      [
        'network_delay_startpoint_af',
        'network_delay_endpoint_af'
      ]
    ],
    [
      'network_disconnection_count',
      'network_disconnection_timebin',
      'network_disconnection_severity',
      [
        'network_disconnection_stream_af'
      ]
    ],
    [
      'moas_count',
      'moas_timebin',
      'moas_severity',
      [
        'moas_asn_attacker_af',
        'moas_asn_victim_af'
      ]
    ],
    [
      'bgp_count',
      'bgp_timebin',
      'bgp_severity',
      [
        'bgp_entity_af'
      ]
    ]
  ]
  it('should filter alarms by time range and aggregated attributes', () => {
    const startUnixTime = 1697829300
    const endUnixTime = 1697829300

    const result = AggregatedAlarmsDataModel.filterAlarmsByTime(ALARMS, startUnixTime, endUnixTime, AGGREGATED_ATTRS_ZIPPED);

    const expectedResult = [
      {
        asn: 27717,
        asn_name: 'Corporacion Digitel C.A.',
        asn_country: 'Venezuela',
        asn_country_iso_code2: 'VE',
        asn_country_iso_code3: 'VEN',
        network_delay_startpoint: [27717, 27717],
        network_delay_startpoint_type: ['AS', 'AS'],
        network_delay_startpoint_name: ['Corporacion Digitel C.A.', 'Corporacion Digitel C.A.'],
        network_delay_startpoint_country: ['Venezuela', 'Venezuela'],
        network_delay_startpoint_country_iso_code2: ['VE', 'VE'],
        network_delay_startpoint_country_iso_code3: ['VEN', 'VEN'],
        network_delay_startpoint_af: [4, 4],
        network_delay_endpoint: [3320, 3320],
        network_delay_endpoint_type: ['AS', 'AS'],
        network_delay_endpoint_name: ['DTAG Deutsche Telekom AG', 'DTAG Deutsche Telekom AG'],
        network_delay_endpoint_country: ['Germany', 'Germany'],
        network_delay_endpoint_country_iso_code2: ['DE', 'DE'],
        network_delay_endpoint_country_iso_code3: ['DEU', 'DEU'],
        network_delay_endpoint_af: [4, 4],
        network_delay_count: [1, 1],
        network_delay_timebin: [1697829300, 1697829300],
        network_delay_severity: ['low', 'low'],
        network_delay_deviation: [10.0817387384346, 10.6897085814724],
        network_delay_key: 'startpoint',
        asn_name_truncated: 'Corporacio (AS27717)'
      }
    ]

    expect(result).toEqual(expectedResult);
  });

  it('should return an empty array if no alarms match the time range', () => {
    const startUnixTime = new Date(2200, 0, 1).getTime() / 1000
    const endUnixTime = new Date(2250, 0, 1).getTime() / 1000

    const result = AggregatedAlarmsDataModel.filterAlarmsByTime(ALARMS, startUnixTime, endUnixTime, AGGREGATED_ATTRS_ZIPPED);
    expect(result).toHaveLength(0);
  });

  it('should handle edge case with no aggregated attributes', () => {
    const emptyAggregatedAttrs = [];
    const startUnixTime = 1697760000
    const endUnixTime = 1697846399
    const result = AggregatedAlarmsDataModel.filterAlarmsByTime(ALARMS, startUnixTime, endUnixTime, emptyAggregatedAttrs);
    expect(result).toHaveLength(0);
  });
});

describe('filterAlarmsBySeverity', () => {
  const AGGREGATED_ATTRS_ZIPPED = [
    [
      'hegemony_count',
      'hegemony_timebin',
      'hegemony_severity',
      [
        'hegemony_origin_asn_af',
        'hegemony_asn_af'
      ]
    ],
    [
      'network_delay_count',
      'network_delay_timebin',
      'network_delay_severity',
      [
        'network_delay_startpoint_af',
        'network_delay_endpoint_af'
      ]
    ],
    [
      'network_disconnection_count',
      'network_disconnection_timebin',
      'network_disconnection_severity',
      [
        'network_disconnection_stream_af'
      ]
    ],
    [
      'moas_count',
      'moas_timebin',
      'moas_severity',
      [
        'moas_asn_attacker_af',
        'moas_asn_victim_af'
      ]
    ],
    [
      'bgp_count',
      'bgp_timebin',
      'bgp_severity',
      [
        'bgp_entity_af'
      ]
    ]
  ]
  it('should filter alarms by high severity and aggregated attributes', () => {
    const severitiesSelected = ['high']

    const result = AggregatedAlarmsDataModel.filterAlarmsBySeverity(ALARMS, severitiesSelected, AGGREGATED_ATTRS_ZIPPED);

    const expectedResult = [
      {
        asn: 1,
        asn_name: 'LVLT-1',
        asn_country: 'United States',
        asn_country_iso_code2: 'US',
        asn_country_iso_code3: 'USA',
        moas_asn_attacker: [1],
        moas_asn_attacker_name: ['LVLT-1'],
        moas_asn_attacker_country: ['United States'],
        moas_asn_attacker_country_iso_code2: ['US'],
        moas_asn_attacker_country_iso_code3: ['USA'],
        moas_asn_attacker_af: ['4, 4'],
        moas_asn_attacker_newcomer: [true],
        moas_asn_attacker_attacking_prefix: ['103.28.85.0/24, 103.98.129.0/24'],
        moas_asn_attacker_trustworthy: [true],
        moas_asn_attacker_trustworthy_tag: [
          'all-newcomers-next-to-an-oldcomer, newcomer-small-asn, rpki-all-newcomer-invalid-roa, rpki-some-newcomer-invalid-roa, not-previously-announced-by-any-newcomer'
        ],
        moas_asn_victim: [58504],
        moas_asn_victim_name: ['TECHMINDS-NP TECHMINDS NETWORKS PVT. LTD.'],
        moas_asn_victim_country: ['Nepal'],
        moas_asn_victim_country_iso_code2: ['NP'],
        moas_asn_victim_country_iso_code3: ['NPL'],
        moas_asn_victim_newcomer: [false],
        moas_asn_victim_trustworthy: [true],
        moas_asn_victim_trustworthy_tag: [
          'all-newcomers-next-to-an-oldcomer, newcomer-small-asn, rpki-all-newcomer-invalid-roa, rpki-some-newcomer-invalid-roa, not-previously-announced-by-any-newcomer'
        ],
        moas_asn_victim_af: ['4, 4'],
        moas_timebin: [1697784625],
        moas_count: [1],
        moas_severity: ['high'],
        moas_deviation: [80],
        moas_duration: [5],
        moas_key: 'asn_attacker',
        asn_name_truncated: 'LVLT-1 (AS1)',
        bgp_entity: [1],
        bgp_entity_type: ['asn'],
        bgp_entity_name: ['LVLT-1'],
        bgp_entity_country: ['United States'],
        bgp_entity_country_iso_code2: ['US'],
        bgp_entity_country_iso_code3: ['USA'],
        bgp_entity_af: ['4, 6'],
        bgp_entity_ip_count: [11416],
        bgp_entity_alarm_type: ['bgp'],
        bgp_condition: ['< 0.99'],
        bgp_value: [56],
        bgp_historical_value: [57],
        bgp_severity: ['high'],
        bgp_timebin: [1697781900],
        bgp_count: [1],
        bgp_key: 'entity'
      },
      {
        asn: 2,
        asn_name: 'UDEL-DCN',
        asn_country: 'United States',
        asn_country_iso_code2: 'US',
        asn_country_iso_code3: 'USA',
        moas_asn_attacker: [2],
        moas_asn_attacker_name: ['UDEL-DCN'],
        moas_asn_attacker_country: ['United States'],
        moas_asn_attacker_country_iso_code2: ['US'],
        moas_asn_attacker_country_iso_code3: ['USA'],
        moas_asn_attacker_af: [4],
        moas_asn_attacker_newcomer: [true],
        moas_asn_attacker_attacking_prefix: ['103.120.237.0/24'],
        moas_asn_attacker_trustworthy: [true],
        moas_asn_attacker_trustworthy_tag: [
          'rpki-all-newcomer-invalid-roa, rpki-all-oldcomer-invalid-roa, rpki-some-newcomer-invalid-roa, origin-small-edit-distance, rpki-some-oldcomer-invalid-roa, not-previously-announced-by-any-newcomer'
        ],
        moas_asn_victim: [4],
        moas_asn_victim_name: ['ISI-AS'],
        moas_asn_victim_country: ['United States'],
        moas_asn_victim_country_iso_code2: ['US'],
        moas_asn_victim_country_iso_code3: ['USA'],
        moas_asn_victim_newcomer: [false],
        moas_asn_victim_trustworthy: [true],
        moas_asn_victim_trustworthy_tag: [
          'rpki-all-newcomer-invalid-roa, rpki-all-oldcomer-invalid-roa, rpki-some-newcomer-invalid-roa, origin-small-edit-distance, rpki-some-oldcomer-invalid-roa, not-previously-announced-by-any-newcomer'
        ],
        moas_asn_victim_af: [4],
        moas_timebin: [1697794226],
        moas_count: [1],
        moas_severity: ['high'],
        moas_deviation: [80],
        moas_duration: [45],
        moas_key: 'asn_attacker',
        asn_name_truncated: 'UDEL-DCN (AS2)'
      }
    ]
    expect(result).toEqual(expectedResult)
  });

  it('should filter alarms by multiple severities and aggregated attributes', () => {
    const severitiesSelected = ['high', 'low']
    const result = AggregatedAlarmsDataModel.filterAlarmsBySeverity(ALARMS, severitiesSelected, AGGREGATED_ATTRS_ZIPPED);

    const expectedResult = [
      {
        asn: 1,
        asn_name: 'LVLT-1',
        asn_country: 'United States',
        asn_country_iso_code2: 'US',
        asn_country_iso_code3: 'USA',
        moas_asn_attacker: [1],
        moas_asn_attacker_name: ['LVLT-1'],
        moas_asn_attacker_country: ['United States'],
        moas_asn_attacker_country_iso_code2: ['US'],
        moas_asn_attacker_country_iso_code3: ['USA'],
        moas_asn_attacker_af: ['4, 4'],
        moas_asn_attacker_newcomer: [true],
        moas_asn_attacker_attacking_prefix: ['103.28.85.0/24, 103.98.129.0/24'],
        moas_asn_attacker_trustworthy: [true],
        moas_asn_attacker_trustworthy_tag: [
          'all-newcomers-next-to-an-oldcomer, newcomer-small-asn, rpki-all-newcomer-invalid-roa, rpki-some-newcomer-invalid-roa, not-previously-announced-by-any-newcomer'
        ],
        moas_asn_victim: [58504],
        moas_asn_victim_name: ['TECHMINDS-NP TECHMINDS NETWORKS PVT. LTD.'],
        moas_asn_victim_country: ['Nepal'],
        moas_asn_victim_country_iso_code2: ['NP'],
        moas_asn_victim_country_iso_code3: ['NPL'],
        moas_asn_victim_newcomer: [false],
        moas_asn_victim_trustworthy: [true],
        moas_asn_victim_trustworthy_tag: [
          'all-newcomers-next-to-an-oldcomer, newcomer-small-asn, rpki-all-newcomer-invalid-roa, rpki-some-newcomer-invalid-roa, not-previously-announced-by-any-newcomer'
        ],
        moas_asn_victim_af: ['4, 4'],
        moas_timebin: [1697784625],
        moas_count: [1],
        moas_severity: ['high'],
        moas_deviation: [80],
        moas_duration: [5],
        moas_key: 'asn_attacker',
        asn_name_truncated: 'LVLT-1 (AS1)',
        bgp_entity: [1],
        bgp_entity_type: ['asn'],
        bgp_entity_name: ['LVLT-1'],
        bgp_entity_country: ['United States'],
        bgp_entity_country_iso_code2: ['US'],
        bgp_entity_country_iso_code3: ['USA'],
        bgp_entity_af: ['4, 6'],
        bgp_entity_ip_count: [11416],
        bgp_entity_alarm_type: ['bgp'],
        bgp_condition: ['< 0.99'],
        bgp_value: [56],
        bgp_historical_value: [57],
        bgp_severity: ['high'],
        bgp_timebin: [1697781900],
        bgp_count: [1],
        bgp_key: 'entity'
      },
      {
        asn: 2,
        asn_name: 'UDEL-DCN',
        asn_country: 'United States',
        asn_country_iso_code2: 'US',
        asn_country_iso_code3: 'USA',
        moas_asn_attacker: [2],
        moas_asn_attacker_name: ['UDEL-DCN'],
        moas_asn_attacker_country: ['United States'],
        moas_asn_attacker_country_iso_code2: ['US'],
        moas_asn_attacker_country_iso_code3: ['USA'],
        moas_asn_attacker_af: [4],
        moas_asn_attacker_newcomer: [true],
        moas_asn_attacker_attacking_prefix: ['103.120.237.0/24'],
        moas_asn_attacker_trustworthy: [true],
        moas_asn_attacker_trustworthy_tag: [
          'rpki-all-newcomer-invalid-roa, rpki-all-oldcomer-invalid-roa, rpki-some-newcomer-invalid-roa, origin-small-edit-distance, rpki-some-oldcomer-invalid-roa, not-previously-announced-by-any-newcomer'
        ],
        moas_asn_victim: [4],
        moas_asn_victim_name: ['ISI-AS'],
        moas_asn_victim_country: ['United States'],
        moas_asn_victim_country_iso_code2: ['US'],
        moas_asn_victim_country_iso_code3: ['USA'],
        moas_asn_victim_newcomer: [false],
        moas_asn_victim_trustworthy: [true],
        moas_asn_victim_trustworthy_tag: [
          'rpki-all-newcomer-invalid-roa, rpki-all-oldcomer-invalid-roa, rpki-some-newcomer-invalid-roa, origin-small-edit-distance, rpki-some-oldcomer-invalid-roa, not-previously-announced-by-any-newcomer'
        ],
        moas_asn_victim_af: [4],
        moas_timebin: [1697794226],
        moas_count: [1],
        moas_severity: ['high'],
        moas_deviation: [80],
        moas_duration: [45],
        moas_key: 'asn_attacker',
        asn_name_truncated: 'UDEL-DCN (AS2)'
      },
      {
        asn: 27717,
        asn_name: 'Corporacion Digitel C.A.',
        asn_country: 'Venezuela',
        asn_country_iso_code2: 'VE',
        asn_country_iso_code3: 'VEN',
        network_delay_startpoint: [27717, 27717],
        network_delay_startpoint_type: ['AS', 'AS'],
        network_delay_startpoint_name: ['Corporacion Digitel C.A.', 'Corporacion Digitel C.A.'],
        network_delay_startpoint_country: ['Venezuela', 'Venezuela'],
        network_delay_startpoint_country_iso_code2: ['VE', 'VE'],
        network_delay_startpoint_country_iso_code3: ['VEN', 'VEN'],
        network_delay_startpoint_af: [4, 4],
        network_delay_endpoint: [3320, 3320],
        network_delay_endpoint_type: ['AS', 'AS'],
        network_delay_endpoint_name: ['DTAG Deutsche Telekom AG', 'DTAG Deutsche Telekom AG'],
        network_delay_endpoint_country: ['Germany', 'Germany'],
        network_delay_endpoint_country_iso_code2: ['DE', 'DE'],
        network_delay_endpoint_country_iso_code3: ['DEU', 'DEU'],
        network_delay_endpoint_af: [4, 4],
        network_delay_count: [1, 1],
        network_delay_timebin: [1697829300, 1697829300],
        network_delay_severity: ['low', 'low'],
        network_delay_deviation: [10.0817387384346, 10.6897085814724],
        network_delay_key: 'startpoint',
        asn_name_truncated: 'Corporacio (AS27717)'
      }
    ]
    expect(result).toEqual(expectedResult);
  });


  it('should return an empty array if no alarms match the severity', () => {
    const severitiesSelected = ['not found severity']
    const result = AggregatedAlarmsDataModel.filterAlarmsBySeverity(ALARMS, severitiesSelected, AGGREGATED_ATTRS_ZIPPED);
    expect(result).toHaveLength(0);
  });

  it('should handle edge case with no aggregated attributes', () => {
    const severitiesSelected = ['high']
    const emptyAggregatedAttrs = [];
    const result = AggregatedAlarmsDataModel.filterAlarmsBySeverity(ALARMS, severitiesSelected, emptyAggregatedAttrs);
    expect(result).toHaveLength(0);
  });
});

describe('filterAlarmsByIpAddressFamily', () => {
  const AGGREGATED_ATTRS_ZIPPED = [
    [
      'hegemony_count',
      'hegemony_timebin',
      'hegemony_severity',
      [
        'hegemony_origin_asn_af',
        'hegemony_asn_af'
      ]
    ],
    [
      'network_delay_count',
      'network_delay_timebin',
      'network_delay_severity',
      [
        'network_delay_startpoint_af',
        'network_delay_endpoint_af'
      ]
    ],
    [
      'network_disconnection_count',
      'network_disconnection_timebin',
      'network_disconnection_severity',
      [
        'network_disconnection_stream_af'
      ]
    ],
    [
      'moas_count',
      'moas_timebin',
      'moas_severity',
      [
        'moas_asn_attacker_af',
        'moas_asn_victim_af'
      ]
    ],
    [
      'bgp_count',
      'bgp_timebin',
      'bgp_severity',
      [
        'bgp_entity_af'
      ]
    ]
  ]
  it('should filter alarms by ip address family and aggregated attributes', () => {
    const ipAddressFamilies1 = [6]
    const ipAddressFamilies2 = [4]

    const result1 = AggregatedAlarmsDataModel.filterAlarmsByIpAddressFamily(ALARMS, ipAddressFamilies1, AGGREGATED_ATTRS_ZIPPED);
    const result2 = AggregatedAlarmsDataModel.filterAlarmsByIpAddressFamily(ALARMS, ipAddressFamilies2, AGGREGATED_ATTRS_ZIPPED);

    const expectedResult1 = [
      {
        asn: 1,
        asn_name: 'LVLT-1',
        asn_country: 'United States',
        asn_country_iso_code2: 'US',
        asn_country_iso_code3: 'USA',
        asn_name_truncated: 'LVLT-1 (AS1)',
        bgp_entity: [1, 1],
        bgp_entity_type: ['asn', 'asn'],
        bgp_entity_name: ['LVLT-1', 'LVLT-1'],
        bgp_entity_country: ['United States', 'United States'],
        bgp_entity_country_iso_code2: ['US', 'US'],
        bgp_entity_country_iso_code3: ['USA', 'USA'],
        bgp_entity_af: ['4, 6', '4, 6'],
        bgp_entity_ip_count: [11416, 11416],
        bgp_entity_alarm_type: ['bgp', 'bgp'],
        bgp_condition: ['normal', '< 0.99'],
        bgp_value: [58, 56],
        bgp_historical_value: [57, 57],
        bgp_severity: ['medium', 'high'],
        bgp_timebin: [1697781600, 1697781900],
        bgp_count: [1, 1],
        bgp_key: 'entity'
      }
    ]
    expect(result1).toEqual(expectedResult1)
    expect(result2).toEqual(ALARMS)
  });

  it('should filter alarms by multiple ip address families and aggregated attributes', () => {
    const ipAddressFamilies = ['4', '6']
    const result = AggregatedAlarmsDataModel.filterAlarmsByIpAddressFamily(ALARMS, ipAddressFamilies, AGGREGATED_ATTRS_ZIPPED);
    expect(result).toEqual(ALARMS);
  });

  it('should return an empty array if no alarms match the ip address family', () => {
    const ipAddressFamilies = [null]
    const result = AggregatedAlarmsDataModel.filterAlarmsByIpAddressFamily(ALARMS, ipAddressFamilies, AGGREGATED_ATTRS_ZIPPED);
    expect(result).toHaveLength(0);
  });

  it('should handle edge case with no aggregated attributes', () => {
    const ipAddressFamilies = ['4']
    const emptyAggregatedAttrs = [];
    const result = AggregatedAlarmsDataModel.filterAlarmsByIpAddressFamily(ALARMS, ipAddressFamilies, emptyAggregatedAttrs);
    expect(result).toHaveLength(0);
  });
})